<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>林伟源的技术博客</title>
  
  
  <link href="https://linweiyuan.github.io/atom.xml" rel="self"/>
  
  <link href="https://linweiyuan.github.io/"/>
  <updated>2023-03-26T01:20:45.362Z</updated>
  <id>https://linweiyuan.github.io/</id>
  
  <author>
    <name>林伟源</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>异步JS</title>
    <link href="https://linweiyuan.github.io/2023/03/19/%E5%BC%82%E6%AD%A5JS.html"/>
    <id>https://linweiyuan.github.io/2023/03/19/%E5%BC%82%E6%AD%A5JS.html</id>
    <published>2023-03-19T06:12:29.000Z</published>
    <updated>2023-03-26T01:20:45.362Z</updated>
    
    <content type="html"><![CDATA[<p>按照国际惯例，说异步之前，需要说下同步</p><h1 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h1><p>比如如下代码，正常来说，会依次打印 123</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br></pre></td></tr></table></figure><p>JS 的代码执行是单线程的，这个不是说 JS 引擎只有一个线程，而是执行代码的是一个线程，另外还有其他的线程做其他的事情</p><p>在上面输出 123 的情况下，如果第二步非常耗时，而这些步骤之间没有强的依赖关系的话，就会影响效率</p><p>这个时候就可以通过回调函数来处理第二步请求，也叫 <code>callback</code></p><h1 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br></pre></td></tr></table></figure><p>在第二步模拟一个耗时操作，比如要用 1 秒，如果按照上面的同步方式，则会输出 1，卡 1 秒后再输出 23，但是如果用回调，则不会阻塞，输出 13，1 秒后再通过回调，输出 2</p><p>耗时任务越多，这个效果越明显</p><p>下面用 XHR 模拟一个比较真实的场景</p><p>XHR 有 5 种状态：<a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/readyState">XMLHttpRequest.readyState</a></p><table><thead><tr><th align="center">Value</th><th align="center">State</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">0</td><td align="center"><code>UNSENT</code></td><td align="center">Client has been created. <code>open()</code> not called yet.</td></tr><tr><td align="center">1</td><td align="center"><code>OPENED</code></td><td align="center"><code>open()</code> has been called.</td></tr><tr><td align="center">2</td><td align="center"><code>HEADERS_RECEIVED</code></td><td align="center"><code>send()</code> has been called, and headers and status are available.</td></tr><tr><td align="center">3</td><td align="center"><code>LOADING</code></td><td align="center">Downloading; <code>responseText</code> holds partial data.</td></tr><tr><td align="center">4</td><td align="center"><code>DONE</code></td><td align="center">The operation is complete.</td></tr></tbody></table><p>在一个普通的请求中，如果正常完成，会返回 <code>DONE</code>，然后就可以根据 xhr 的状态码和 HTTP 的状态码来进行处理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">xhr.<span class="title function_">addEventListener</span>(<span class="string">&quot;readystatechange&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (xhr.<span class="property">readyState</span> === xhr.<span class="property">DONE</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (xhr.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(xhr.<span class="property">responseText</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  xhr.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">  xhr.<span class="title function_">send</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>考虑到可能会在多个地方需要发出这个请求，稍微封装下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getData</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">  xhr.<span class="title function_">addEventListener</span>(<span class="string">&quot;readystatechange&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (xhr.<span class="property">readyState</span> === xhr.<span class="property">DONE</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (xhr.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(xhr.<span class="property">responseText</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  xhr.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">  xhr.<span class="title function_">send</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这样就可以很方便的进行调用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getData</span>();</span><br></pre></td></tr></table></figure><p>如果要通过回调函数的方式，则可以改为</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getData</span> = (<span class="params">callback</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">  xhr.<span class="title function_">addEventListener</span>(<span class="string">&quot;readystatechange&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (xhr.<span class="property">readyState</span> === xhr.<span class="property">DONE</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (xhr.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="title function_">callback</span>(xhr.<span class="property">responseText</span>, <span class="literal">undefined</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">callback</span>(<span class="literal">undefined</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  xhr.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">  xhr.<span class="title function_">send</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getData</span>(<span class="function">(<span class="params">data, err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>传入了一个回调函数，带两个参数，并进行成功与否的处理</p><p>这部分处理很像 Go 的双返回值，太像了</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getData</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> data, <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data, err := getData()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// print data</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果在 <code>getData()</code> 前后分别打印 12，则会输出 12，再执行里面的耗时任务，达到一个异步处理的效果</p><p>这就是回调函数，但是回调函数带来了一个问题</p><p>如果任务之间有强依赖，比如我要先登录，再获取用户信息，再进行另外的操作，如果用回调函数的写法，就会出现一个问题</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">login</span>(<span class="function">(<span class="params">data, err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">    <span class="title function_">getUserInfo</span>(<span class="function">(<span class="params">data, err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        <span class="title function_">getData</span>(<span class="function">(<span class="params">data, err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">            <span class="comment">// ok</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>如果有 N 个请求，就会出现一个 <code>&gt;</code>，业界叫回调地狱</p><p>虽然代码是给机器执行的，但那是编译过的，源代码是给人看的，这样会不好维护</p><p>于是出现了一个新对象 <code>Promise</code></p><h1 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h1><p><code>Promise</code> 用人话说就是一些需要一定的时间去完成的事情，不知道英文为什么叫这个名字，如果你用中文的承诺去套，也可以说得通</p><p>比如你结婚的时候，许下承诺，一辈子，那就是需要很长时间来完成的事情</p><p><code>Promise</code> 会出现两种可能的结果：</p><ul><li>成功的时候，走 <code>resolve</code></li><li>失败则走 <code>reject</code></li></ul><p>同时也接收这两个函数作为参数</p><p>这样上面的 <code>getData()</code> 就可以改写成</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getData</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    xhr.<span class="title function_">addEventListener</span>(<span class="string">&quot;readystatechange&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (xhr.<span class="property">readyState</span> === xhr.<span class="property">DONE</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (xhr.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(xhr.<span class="property">responseText</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    xhr.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">    xhr.<span class="title function_">send</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>而 <code>Promise</code> 的后续一般用 <code>then()</code> 来处理 <code>resolve</code> 的结果，<code>catch()</code> 来处理 <code>reject</code> 的结果</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getData</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err));</span><br></pre></td></tr></table></figure><p>那么 <code>Promise</code> 是如何解决回调地狱的?</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">login</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getUserInfo</span>();</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getData</span>();</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>既然每个请求都返回 <code>Promise</code>，而 <code>Promise</code> 又要 <code>then()</code> 来处理，那么通过将 <code>Promise</code> 进行 <code>return</code>， 再通过 <code>then()</code> 来处理，则可完成相同的效果</p><p>这样在一定程度上避免的回调的嵌套，但是还是不太直观</p><p>那么还有没有另外的方式？</p><p>有</p><h1 id="async-x2F-await"><a href="#async-x2F-await" class="headerlink" title="async &#x2F; await"></a>async &#x2F; await</h1><p>通过将函数设置为 <code>async</code>，在这个异步函数内部则可通过 <code>await</code> 来进行顺序的处理</p><p>改写上面方法，要定义一个异步方法，<code>async</code> 关键字要写在 <code>function</code> 前面，如果是箭头函数，则在参数前面</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getData</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> loginResponse = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;login&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> loginData = <span class="keyword">await</span> loginResponse.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> userInfoResponse = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;userInfo&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> userInfoData = <span class="keyword">await</span> userInfoResponse.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> data = response.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>由于 <code>fetch</code> 本身是异步的，返回一个 <code>Promise</code>，因此里面通过 <code>await</code> 关键字可以得到最终的结果</p><p>又由于这个方法也设置成了异步方法，所以也需要通过 <code>then()</code> 再来进行最后的处理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getData</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data));</span><br></pre></td></tr></table></figure><p>值得注意的是，一般情况下，请求不是 2xx 就会当作失败，出异常，理应走 <code>reject</code>，但是这个 <code>fetch</code> 即使出了 404 或者 500，还是走 <code>resolve</code>，这个时候，需要进一步判断它的 <code>ok</code> 属性或 HTTP 状态码，才能判断请求是否正常</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;按照国际惯例，说异步之前，需要说下同步&lt;/p&gt;
&lt;h1 id=&quot;同步&quot;&gt;&lt;a href=&quot;#同步&quot; class=&quot;headerlink&quot; title=&quot;同步&quot;&gt;&lt;/a&gt;同步&lt;/h1&gt;&lt;p&gt;比如如下代码，正常来说，会依次打印 123&lt;/p&gt;
&lt;figure class=&quot;hi</summary>
      
    
    
    
    <category term="程序设计" scheme="https://linweiyuan.github.io/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    
    
    <category term="JavaScript" scheme="https://linweiyuan.github.io/tags/JavaScript/"/>
    
    <category term="Promise" scheme="https://linweiyuan.github.io/tags/Promise/"/>
    
  </entry>
  
  <entry>
    <title>一种取巧的方式绕过Cloudflare v2验证</title>
    <link href="https://linweiyuan.github.io/2023/03/14/%E4%B8%80%E7%A7%8D%E5%8F%96%E5%B7%A7%E7%9A%84%E6%96%B9%E5%BC%8F%E7%BB%95%E8%BF%87Cloudflare-v2%E9%AA%8C%E8%AF%81.html"/>
    <id>https://linweiyuan.github.io/2023/03/14/%E4%B8%80%E7%A7%8D%E5%8F%96%E5%B7%A7%E7%9A%84%E6%96%B9%E5%BC%8F%E7%BB%95%E8%BF%87Cloudflare-v2%E9%AA%8C%E8%AF%81.html</id>
    <published>2023-03-14T07:09:34.000Z</published>
    <updated>2023-03-26T01:20:45.358Z</updated>
    
    <content type="html"><![CDATA[<p>ChatGPT 一直在反爬虫的方式上下功夫，与第三方 API 开发者斗智斗勇</p><p>网页版服务刚出来的时候，是可以直接调用的</p><p>进入 2023 年，加了 Cloudflare 的验证，这个时候死掉了一堆第三方 API，好多至今仍然是瘫痪状态</p><p>但是通过分析发现，OpenAI 旗下的某个子域名其实在提供着相同的 API 服务，并且没加 CF 验证，于是部分第三方 API 复活</p><p>后面这个域名挂了，另一个域名又出来</p><p>但是在几天前，这个域名也挂了，接口全部 404，之前的第三方 API 又挂了</p><p>留给世人一个难题，如果绕过 CF 验证，方便快捷地使用网页版的服务？</p><p>为什么不用公开 API？总体来说，除了 429，ChatGPT 比公开的 API 智能许多，我都用过有发言权</p><hr><p>在绕过 CF 反爬虫的机制上，做过很多资料查询，使用过各种姿势，最后无一死在 403，尝试过的方式包括：</p><h3 id="请求头修改"><a href="#请求头修改" class="headerlink" title="请求头修改"></a>请求头修改</h3><p>这是最低级的方式，通过修改请求头的方式模拟浏览器，失败</p><h3 id="设置-Cloudflare-Cookie"><a href="#设置-Cloudflare-Cookie" class="headerlink" title="设置 Cloudflare Cookie"></a>设置 Cloudflare Cookie</h3><p>获取 CF 验证码需要的 Cookie，再在请求的时候加上，失败</p><h3 id="JA3-指纹修改"><a href="#JA3-指纹修改" class="headerlink" title="JA3 指纹修改"></a>JA3 指纹修改</h3><p>JA3 指纹识别的原理是什么，这里有篇详细的文章：<a href="https://engineering.salesforce.com/tls-fingerprinting-with-ja3-and-ja3s-247362855967/">TLS Fingerprinting with JA3 and JA3S</a></p><p>这个发生在握手阶段的 Client Hello 包，通过一些算法来计算出 JA3 指纹，简单来说，一个请求库发出的请求的指纹是固定的，比如我可以知道你的请求是不是来自 cURL，如果是，不合法，直接 403</p><p>这个概念有点类似一些库会自动设置 UserAgent，看下日志就能看得到，只是这个 JA3 发生在更底层的协议中</p><p>Java 这语言太高级了，在涉及 SSL&#x2F;TLS 方面的 API 过于复杂，我也缺少相关知识，所以这部分用 Golang 现有的请求库试过，确实能修改到指纹，这样的话，CF 就不知道我们的请求是来自哪个工具了，但是结果仍然是失败</p><h3 id="JS-逆向"><a href="#JS-逆向" class="headerlink" title="JS 逆向"></a>JS 逆向</h3><p>这个尝试过，不是很懂 JS，太耗时间了，但是如果这个成功了，可能会一劳永逸，如果验证算法更新了，有之前的经验可能随便改改就能适配</p><h3 id="自动化测试工具"><a href="#自动化测试工具" class="headerlink" title="自动化测试工具"></a>自动化测试工具</h3><p>如果用浏览器去访问，就非常正常，所以想到另一种思路，可以在我们的第三方 API 的基础上，外挂个浏览器</p><p>顺其自然就会想到用 Selenium 或者其他类似的模拟浏览器的自动化测试工具，发送请求到我们的 API 的时候，模拟浏览器的点击操作发送请求</p><p>但是发现，如果用这些工具打开 ChatGPT，会一直重复出现 CF 验证码，点了之后又出现，再点还出现，无论试了 Selenium、Puppeteer、Playwright，结果都是一样</p><p>查询资料发现，其实这些所谓 <code>WebDriver</code> 的实现都会遵循一个规范，就是使用这些工具的时候，获取 <code>navigator</code> 的 <code>webdriver</code> 属性时，会返回 <code>true</code>，而普通浏览器会返回 <code>undefined</code></p><p>那我们是不是可以覆盖它的默认实现，比如自定义 <code>function</code>，当访问这个属性的时候返回 <code>undefined</code>？试过了，不行，包括加一些 <code>ChromeOptions</code>，也不行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">webDriver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChromeDriver</span>(chromeOptions);</span><br><span class="line">webDriver.executeCdpCommand(<span class="string">&quot;Page.addScriptToEvaluateOnNewDocument&quot;</span>, Map.of(</span><br><span class="line">        <span class="string">&quot;source&quot;</span>, <span class="string">&quot;Object.defineProperty(navigator, &#x27;webdriver&#x27;, &#123;get: () =&gt; undefined&#125;)&quot;</span></span><br><span class="line">));</span><br></pre></td></tr></table></figure><p>正当准备弃坑的时候，发现了一个工具确实能绕过 CF 验证，那就是 <a href="https://github.com/ultrafunkamsterdam/undetected-chromedriver">undetected_chromedriver</a></p><p>利用这个库能通过 CF 验证进入登录界面，是不是就可以登录，然后操作 <code>dom</code> 模拟数据输入和发送呢？理论上是，我没试，因为突然想到了另外一种方式</p><h3 id="XMLHttpRequest"><a href="#XMLHttpRequest" class="headerlink" title="XMLHttpRequest"></a>XMLHttpRequest</h3><p>既然这个 <code>undetected_chromedriver</code> 能正常打开页面，而我们的请求都是 XHR，那如果直接通过 JS 操作 XHR 会发生什么？</p><p>结果是 200，某种程序上来说，已经成功绕过了 CF 验证</p><p>于是开始重写 API，将我们第三方 API 对 ChatGPT 的 API 的调用统统改成 JS</p><p>由于我大多写 Java，对于 JS 掌握得不是很好，这个时候遇到一个难题</p><p>普通的阻塞 API 都可以用 <code>executeScript()</code> 然后通过 <code>return xhr.responseText;</code> 返回响应，但是对话的时候，是 <code>text/event-stream</code>，这个时候如何处理</p><p>我知道 <code>Spring</code> 有个 <code>WebFlux</code> 是专门做这个事情的，但是我们又该如何从 JS 那里接管响应数据呢？ 接管到数据后，如何又把它们整合到 <code>Flux</code> 里返回呢？</p><p>首先是第二个问题的解决方案：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Flux.create(fluxSink -&gt; &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果正常拿到数据</span></span><br><span class="line">        fluxSink.next(data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 没数据了或者报错</span></span><br><span class="line">        fluxSink.complete();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>如何获取数据？</p><p>XHR 默认是同步操作，如果设置为异步操作后，通过判断 XHR 状态码可以判断数据是不是在传输，比如 <code>LOADING</code> 则目前正在返回对话内容，<code>DONE</code> 则结束</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (xhr.<span class="property">readyState</span> === xhr.<span class="property">LOADING</span>) &#123;</span><br><span class="line">    <span class="comment">// 接收数据</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xhr.<span class="property">readyState</span> === xhr.<span class="property">DONE</span>) &#123;</span><br><span class="line">    <span class="comment">// 结束</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>问题在于如何跨语言在 JS 里接收到数据再传到 Java 里，Java 可以通过一些脚本引擎执行 JS，但是在这里并不适用</p><p>于是想到了 <code>callback</code> 的方式，构造一个 Java 对象传进去，编译成功，但是运行报错，不认识传的对象，这个也正常</p><p><img src="/2023/03/14/%E4%B8%80%E7%A7%8D%E5%8F%96%E5%B7%A7%E7%9A%84%E6%96%B9%E5%BC%8F%E7%BB%95%E8%BF%87Cloudflare-v2%E9%AA%8C%E8%AF%81/executeAsyncScript.png"></p><p><img src="/2023/03/14/%E4%B8%80%E7%A7%8D%E5%8F%96%E5%B7%A7%E7%9A%84%E6%96%B9%E5%BC%8F%E7%BB%95%E8%BF%87Cloudflare-v2%E9%AA%8C%E8%AF%81/WebElementToJsonConverter.png"></p><p>还有别的方法吗，发现有一个 <code>postMessage()</code> 可以用来跨源异步通信，那么不就能满足我们的需求了吗</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;message&quot;</span>, <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;)；</span><br></pre></td></tr></table></figure><p>只是不知如何和 XHR 脚本结合起来，于是有了这些代码：<a href="https://github.com/linweiyuan/java-chatgpt-api/blob/main/src/main/java/com/linweiyuan/java-chatgpt-api/service/impl/ConversationServiceImpl.java#L160-L174">发送请求</a> 和 <a href="https://github.com/linweiyuan/java-chatgpt-api/blob/main/src/main/java/com/linweiyuan/java-chatgpt-api/service/impl/ConversationServiceImpl.java#L180-L192">接收数据</a></p><p>因为异步脚本执行要通过 callback 返回数据，而这个 callback 又不能设置在 XHR 发送阶段，因为要频繁 callback 返回数据，这样就会频繁发送请求，所以必须在新的方法里处理，而这个 <code>postMessage()</code> 又需要通过 <code>addEventListener()</code> 的方式获取，所以这里很多矛盾的地方</p><p>我也不是很清楚频繁 <code>addEventListener</code> 会发生什么，有尝试过一些判断，如果没有设置过再设置，不好使</p><p>不清楚设置多个会不会接收到重复数据，于是代码里先 <code>remove</code> 再 <code>add</code>，不知道合不合理，这个是目前得到的最折中的方法，并且能实现想要的效果，只是异步脚本执行会频繁超时，导致报错，这个还没知道怎么解决</p><h3 id="undetected-chromedriver"><a href="#undetected-chromedriver" class="headerlink" title="undetected_chromedriver"></a>undetected_chromedriver</h3><p>这个库是如何做到不被检测出来的，它在启动的时候修改了 driver 的一些数据，在运行时可以看到会打印在 <code>console</code> 里：</p><ul><li><a href="https://github.com/ultrafunkamsterdam/undetected-chromedriver/blob/master/undetected_chromedriver/__init__.py#L246">https://github.com/ultrafunkamsterdam/undetected-chromedriver/blob/master/undetected_chromedriver/__init__.py#L246</a></li><li><a href="https://github.com/ultrafunkamsterdam/undetected-chromedriver/blob/master/undetected_chromedriver/patcher.py#L91-L99">https://github.com/ultrafunkamsterdam/undetected-chromedriver/blob/master/undetected_chromedriver/patcher.py#L91-L99</a></li><li><a href="https://github.com/ultrafunkamsterdam/undetected-chromedriver/blob/master/undetected_chromedriver/patcher.py#L222-L228">https://github.com/ultrafunkamsterdam/undetected-chromedriver/blob/master/undetected_chromedriver/patcher.py#L222-L228</a></li></ul><p>而在运行的时候，修改过的 driver 会放在 <code>~/.local/share/undetected_chromedriver</code> 里，运行完会删除，可以趁这个时间复制出来供后续使用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">./undetected_chromedriver --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Usage: ./undetected_chromedriver [OPTIONS]</span><br><span class="line"></span><br><span class="line">Options</span><br><span class="line">  --port=PORT                     port to listen on</span><br><span class="line">  --adb-port=PORT                 adb server port</span><br><span class="line">  --log-path=FILE                 write server <span class="built_in">log</span> to file instead of stderr, increases <span class="built_in">log</span> level to INFO</span><br><span class="line">  --log-level=LEVEL               <span class="built_in">set</span> <span class="built_in">log</span> level: ALL, DEBUG, INFO, WARNING, SEVERE, OFF</span><br><span class="line">  --verbose                       <span class="built_in">log</span> verbosely (equivalent to --log-level=ALL)</span><br><span class="line">  --silent                        <span class="built_in">log</span> nothing (equivalent to --log-level=OFF)</span><br><span class="line">  --append-log                    append <span class="built_in">log</span> file instead of rewriting</span><br><span class="line">  --replayable                    (experimental) <span class="built_in">log</span> verbosely and don<span class="string">&#x27;t truncate long strings so that the log can be replayed.</span></span><br><span class="line"><span class="string">  --version                       print the version number and exit</span></span><br><span class="line"><span class="string">  --url-base                      base URL path prefix for commands, e.g. wd/url</span></span><br><span class="line"><span class="string">  --readable-timestamp            add readable timestamps to log</span></span><br><span class="line"><span class="string">  --enable-chrome-logs            show logs from the browser (overrides other logging options)</span></span><br><span class="line"><span class="string">  --bidi-mapper-path              custom bidi mapper path</span></span><br><span class="line"><span class="string">  --disable-dev-shm-usage         do not use /dev/shm (add this switch if seeing errors related to shared memory)</span></span><br><span class="line"><span class="string">  --allowed-ips=LIST              comma-separated allowlist of remote IP addresses which are allowed to connect to ChromeDriver</span></span><br><span class="line"><span class="string">  --allowed-origins=LIST          comma-separated allowlist of request origins which are allowed to connect to ChromeDriver. Using `*` to allow any host origin is dangerous!</span></span><br></pre></td></tr></table></figure><p>在本地测试的时候可以使用 <code>undetected_chromedriver --allowed-ips=&quot;&quot; --allowed-origins=&quot;*&quot;</code> 来启动，公网要考虑风险</p><p>这样就能在 API 外再套一层这个来绕过 Cloudflare v2 验证了</p><p>网页版使用的时候，需要频繁刷新，尝试过写个定时器去主动刷新，效果是可以的，只是如果在对话响应处理的过程中的时候刚好碰上自动刷新，就会戛然而止，于是改为了被动刷新</p><p>如果请求过来，先发一个 XHR 去看下是不是 200，如果是 403，则刷新网页拿新 Cookie，再去请求 API，效果也还行</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>第三方 API:</p><ul><li>基于 Java 实现：<a href="https://github.com/linweiyuan/java-chatgpt-api">java-chatgpt-api</a></li><li>基于 Go 实现：<a href="https://github.com/linweiyuan/go-chatgpt-api">go-chatgpt-api</a></li></ul><p>第三方客户端：</p><ul><li>Java 图形化界面：<a href="https://github.com/linweiyuan/ChatGPT-Swing">ChatGPT-Swing</a></li><li>Go 终端程序：<a href="https://github.com/linweiyuan/go-chatgpt">go-chatgpt</a></li></ul><h3 id="视频"><a href="#视频" class="headerlink" title="视频"></a>视频</h3><div>  <video-js id="videojs-id-e42bf689-a765-4a65-bf24-0b78db9b115d"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/chatgpt-proxy-server/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojside42bf689a7654a65bf240b78db9b115d = videojs('videojs-id-e42bf689-a765-4a65-bf24-0b78db9b115d', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ChatGPT 一直在反爬虫的方式上下功夫，与第三方 API 开发者斗智斗勇&lt;/p&gt;
&lt;p&gt;网页版服务刚出来的时候，是可以直接调用的&lt;/p&gt;
&lt;p&gt;进入 2023 年，加了 Cloudflare 的验证，这个时候死掉了一堆第三方 API，好多至今仍然是瘫痪状态&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/categories/ChatGPT/"/>
    
    
    <category term="Java" scheme="https://linweiyuan.github.io/tags/Java/"/>
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/tags/ChatGPT/"/>
    
    <category term="Selenium" scheme="https://linweiyuan.github.io/tags/Selenium/"/>
    
    <category term="Golang" scheme="https://linweiyuan.github.io/tags/Golang/"/>
    
    <category term="Cloudflare" scheme="https://linweiyuan.github.io/tags/Cloudflare/"/>
    
  </entry>
  
  <entry>
    <title>go-chatgpt</title>
    <link href="https://linweiyuan.github.io/2023/03/05/go-chatgpt.html"/>
    <id>https://linweiyuan.github.io/2023/03/05/go-chatgpt.html</id>
    <published>2023-03-05T09:01:34.000Z</published>
    <updated>2023-03-26T01:20:45.354Z</updated>
    
    <content type="html"><![CDATA[<p>弄了个终端版，只需 <code>accessToken</code> 即可使用，非常简洁</p><p>简洁到连异常处理都没有做，勉强能用：<a href="https://github.com/linweiyuan/go-chatgpt">go-chatgpt</a></p><script async id="asciicast-dh8QWcMPpefJ4mQ4n4i5E3ITc" src="https://asciinema.org/a/dh8QWcMPpefJ4mQ4n4i5E3ITc.js"></script>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;弄了个终端版，只需 &lt;code&gt;accessToken&lt;/code&gt; 即可使用，非常简洁&lt;/p&gt;
&lt;p&gt;简洁到连异常处理都没有做，勉强能用：&lt;a href=&quot;https://github.com/linweiyuan/go-chatgpt&quot;&gt;go-chatgpt&lt;/a&gt;&lt;/</summary>
      
    
    
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/categories/ChatGPT/"/>
    
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/tags/ChatGPT/"/>
    
    <category term="Golang" scheme="https://linweiyuan.github.io/tags/Golang/"/>
    
    <category term="TUI" scheme="https://linweiyuan.github.io/tags/TUI/"/>
    
  </entry>
  
  <entry>
    <title>ChatGPT-Swing</title>
    <link href="https://linweiyuan.github.io/2023/02/25/ChatGPT-Swing.html"/>
    <id>https://linweiyuan.github.io/2023/02/25/ChatGPT-Swing.html</id>
    <published>2023-02-25T07:36:39.000Z</published>
    <updated>2023-03-26T01:20:45.346Z</updated>
    
    <content type="html"><![CDATA[<h1 id="由于官方关闭了用到的-API，部分内容已过期"><a href="#由于官方关闭了用到的-API，部分内容已过期" class="headerlink" title="由于官方关闭了用到的 API，部分内容已过期"></a>由于官方关闭了用到的 API，部分内容已过期</h1><hr><p><strong><a href="https://github.com/linweiyuan/ChatGPT-Swing">ChatGPT-Swing</a></strong> 是一个非官方的 GUI 程序，利用 Java Swing 技术实现，基于网页版 ChatGPT（3.5），而非公开的 GPT-3 API。利用这个程序，你可以做很多网页版可以做的事（<code>Regenerate response</code> 感觉没必要就没做），包括：</p><ul><li>账号登录（谷歌账号和微软账号还没测试）</li><li>accessToken 自动刷新（比如明天过期，今天打开程序就会尝试刷新）</li><li>对话新增与聊天（支持关联上下文）</li><li>删除单个对话（看请求参数其实是隐藏，但隐藏后你再访问这个 id 就会 404）</li><li>删除所有对话</li><li>重命名对话标题</li><li>消息反馈（点赞或点踩）</li><li>文本转语音（调用 <a href="https://freetts.com/">Free TTS</a> 的在线测试服务，每周对单个 IP 有字数限制，这个网站是支持很多语言的，程序里目前仅支持英语，写死了）</li></ul><p>同时免除了烦人的 Cloudflare 验证，挂机后回来随时对话无需刷新网页</p><p>缺点就是非官方 API，随时失效，还可能有 Bug</p><hr><p>项目依赖</p><p><img src="/2023/02/25/ChatGPT-Swing/dependencies.png"></p><hr><h1 id="下面是部分截图"><a href="#下面是部分截图" class="headerlink" title="下面是部分截图"></a>下面是部分截图</h1><h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><p><img src="/2023/02/25/ChatGPT-Swing/login.png"></p><p>程序一开始的设计是直接访问 ChatGPT 服务，这个选项就有用，因为登录的时候会检测当前国家或地区是否支持，登录完成后再调用其他 API 一般就不用了，通常都可以直连，所以这个代理选项只对登录接口有效，并且是本地代理，不是说设置了之后服务器就会用这个代理再去访问 ChatGPT 服务</p><p>后来用 Go 测试登录，发现，在我本地相同的网络环境下，如果 Kotlin 这边直接调用 ChatGPT 登录服务，整套流程包括拿 CSRF token 和一些重定向、用户名密码检测、最终拿 accessToken，需要 10 秒左右</p><p>神奇的事情发生了，利用 Go 去登录，仅需 5 秒左右，于是干脆起了个 Gin 服务，转发所有请求</p><p>这个不是瞎说的，直接登录 ChatGPT 的代码在早期的 commit 里，有兴趣的可以自行 checkout 测试</p><p>但这导致了一个问题，如果当前 IP 不在支持范围内，即使登录时开启代理也没用</p><p>但是我也没删除，就这样先留着了，因为还有一种潜在的场景就是，在你的本地环境下，确实需要代理才能更快地访问你的自建 API 服务，然后 API 服务将登录接口单独再经一层转发到受支持国家或地区服务器（脑回路比较不寻常就是了）</p><h2 id="主界面的组件选择"><a href="#主界面的组件选择" class="headerlink" title="主界面的组件选择"></a>主界面的组件选择</h2><p>每次新建的对话，会自动调用接口生成标题，左边是一个树形组件（根节点隐藏了），跟着的节点是每个对话，其中显示的是对话标题。对话下面的是每次问答，其中问的问题会作为对话的子节点加入树中，中间区域则显示 ChatGPT 的响应信息</p><p>这部分 UI 经过了重构，一开始打算用 <code>JList</code>，类似网页版的效果，点击显示所有，然后中间用 <code>JTextArea</code> 直接追加就完了，但是请求和响应颜色一样，看瞎眼</p><p>接着中间区域又改成 <code>JTextPane</code>，以 HTML 的方式显示数据，加一些 css 来修改对话的背景色来区分自己的请求的 ChatGPT 的响应，也不好使，勉强能用</p><p>左边后来改成了 <code>JTree</code>，点击父节点显示整个对话内容，点击子节点就显示本次问答，测试完成差强人意</p><p>然后无意中发现了一个好用的库 <code>RSyntaxTextArea</code>，解决了代码高亮、折叠等问题，除了 <code>&#39;s</code> 这个符号偶尔错误解析自动换行，最终的效果就比较理想了，也就是现在的模样</p><h3 id="点击父节点显示整个对话内容（关联上下文）"><a href="#点击父节点显示整个对话内容（关联上下文）" class="headerlink" title="点击父节点显示整个对话内容（关联上下文）"></a>点击父节点显示整个对话内容（关联上下文）</h3><p><img src="/2023/02/25/ChatGPT-Swing/context_association.png"></p><h3 id="点击子节点显示本次请求响应"><a href="#点击子节点显示本次请求响应" class="headerlink" title="点击子节点显示本次请求响应"></a>点击子节点显示本次请求响应</h3><p><img src="/2023/02/25/ChatGPT-Swing/show_message.png"></p><h3 id="代码高亮"><a href="#代码高亮" class="headerlink" title="代码高亮"></a>代码高亮</h3><p><img src="/2023/02/25/ChatGPT-Swing/highlight_selection.png"></p><p><img src="/2023/02/25/ChatGPT-Swing/syntax_highlight.png"></p><p><img src="/2023/02/25/ChatGPT-Swing/Linux.png"></p><p><img src="/2023/02/25/ChatGPT-Swing/macOS.png"></p><p><code>RSyntaxTextArea</code> <a href="https://github.com/bobbylight/RSyntaxTextArea/blob/master/RSyntaxTextArea/src/main/java/org/fife/ui/rsyntaxtextarea/SyntaxConstants.java">内建支持列表</a></p><h3 id="父节点右键菜单"><a href="#父节点右键菜单" class="headerlink" title="父节点右键菜单"></a>父节点右键菜单</h3><p><img src="/2023/02/25/ChatGPT-Swing/conversation_menu.png"></p><ul><li>刷新选中对话内容</li><li>重命名选中对话<br><img src="/2023/02/25/ChatGPT-Swing/rename_conversation.png"><br><img src="/2023/02/25/ChatGPT-Swing/rename_conversation_after.png"></li><li>删除选中对话<br><img src="/2023/02/25/ChatGPT-Swing/delete_conversation.png"><br><img src="/2023/02/25/ChatGPT-Swing/delete_conversation_after.png"></li></ul><h3 id="清空所有对话"><a href="#清空所有对话" class="headerlink" title="清空所有对话"></a>清空所有对话</h3><p><img src="/2023/02/25/ChatGPT-Swing/clear_all_conversations.png"></p><h3 id="子节点右键菜单"><a href="#子节点右键菜单" class="headerlink" title="子节点右键菜单"></a>子节点右键菜单</h3><p><img src="/2023/02/25/ChatGPT-Swing/message_menu.png"></p><ul><li>反馈（这里没有加文本反馈，网页版有，并且网页版如果点赞了再点踩是可以的，这里会报错）<br><img src="/2023/02/25/ChatGPT-Swing/feedback.png"><br><img src="/2023/02/25/ChatGPT-Swing/feedback_done.png"><br><img src="/2023/02/25/ChatGPT-Swing/feedback_error.png"></li></ul><h3 id="文本转语音"><a href="#文本转语音" class="headerlink" title="文本转语音"></a>文本转语音</h3><p>选中文本点击 TTS 按钮则可（这个有诸多限制，在文章一开始有写）</p><hr><h1 id="演示视频"><a href="#演示视频" class="headerlink" title="演示视频"></a>演示视频</h1><div>  <video-js id="videojs-id-6f249ee4-c91c-486f-85f6-51c388b56c3a"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/chatgpt-swing/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsid6f249ee4c91c486f85f651c388b56c3a = videojs('videojs-id-6f249ee4-c91c-486f-85f6-51c388b56c3a', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;由于官方关闭了用到的-API，部分内容已过期&quot;&gt;&lt;a href=&quot;#由于官方关闭了用到的-API，部分内容已过期&quot; class=&quot;headerlink&quot; title=&quot;由于官方关闭了用到的 API，部分内容已过期&quot;&gt;&lt;/a&gt;由于官方关闭了用到的 API，部分内容已</summary>
      
    
    
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/categories/ChatGPT/"/>
    
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="Java" scheme="https://linweiyuan.github.io/tags/Java/"/>
    
    <category term="Kotlin" scheme="https://linweiyuan.github.io/tags/Kotlin/"/>
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/tags/ChatGPT/"/>
    
    <category term="Swing" scheme="https://linweiyuan.github.io/tags/Swing/"/>
    
  </entry>
  
  <entry>
    <title>jsoup1.15.4奇怪bug排查</title>
    <link href="https://linweiyuan.github.io/2023/02/22/jsoup1-15-4%E5%A5%87%E6%80%AAbug%E6%8E%92%E6%9F%A5.html"/>
    <id>https://linweiyuan.github.io/2023/02/22/jsoup1-15-4%E5%A5%87%E6%80%AAbug%E6%8E%92%E6%9F%A5.html</id>
    <published>2023-02-22T10:54:55.000Z</published>
    <updated>2023-03-26T01:20:45.354Z</updated>
    
    <content type="html"><![CDATA[<h1 id="官方团队很快就修复了"><a href="#官方团队很快就修复了" class="headerlink" title="官方团队很快就修复了"></a>官方团队很快就修复了</h1><p><a href="https://github.com/jhy/jsoup/issues/1902">https://github.com/jhy/jsoup/issues/1902</a></p><hr><p>jsoup 是目前个人用过的简单易用轻量的很好的一个工具，特别是解析网页方面，爬虫、模拟登录等</p><p>目前有个项目也有用到，我是比较喜欢用新的版本的，所以当时就用了 1.15.3 最新，一直相安无事</p><p>昨天看见 pom.xml 报黄，于是升级至 1.15.4，好多 API 请求都正常</p><p>这里插句题外话，JDK 在源码级别不支持 PATCH 方法，比如 <code>java.net.HttpURLConnection</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.net;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HttpURLConnection</span> <span class="keyword">extends</span> <span class="title class_">URLConnection</span> &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">/* valid HTTP methods */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] methods = &#123;</span><br><span class="line">        <span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;HEAD&quot;</span>, <span class="string">&quot;OPTIONS&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;TRACE&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the method for the URL request, one of:</span></span><br><span class="line"><span class="comment">     * &lt;UL&gt;</span></span><br><span class="line"><span class="comment">     *  &lt;LI&gt;GET</span></span><br><span class="line"><span class="comment">     *  &lt;LI&gt;POST</span></span><br><span class="line"><span class="comment">     *  &lt;LI&gt;HEAD</span></span><br><span class="line"><span class="comment">     *  &lt;LI&gt;OPTIONS</span></span><br><span class="line"><span class="comment">     *  &lt;LI&gt;PUT</span></span><br><span class="line"><span class="comment">     *  &lt;LI&gt;DELETE</span></span><br><span class="line"><span class="comment">     *  &lt;LI&gt;TRACE</span></span><br><span class="line"><span class="comment">     * &lt;/UL&gt; are legal, subject to protocol restrictions.  The default</span></span><br><span class="line"><span class="comment">     * method is GET.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method the HTTP method</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span>    ProtocolException if the method cannot be reset or if</span></span><br><span class="line"><span class="comment">     *              the requested method isn&#x27;t valid for HTTP.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span>    SecurityException if a security manager is set and the</span></span><br><span class="line"><span class="comment">     *              method is &quot;TRACE&quot;, but the &quot;allowHttpTrace&quot;</span></span><br><span class="line"><span class="comment">     *              NetPermission is not granted.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getRequestMethod()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRequestMethod</span><span class="params">(String method)</span> <span class="keyword">throws</span> ProtocolException &#123;</span><br><span class="line">        <span class="keyword">if</span> (connected) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ProtocolException</span>(<span class="string">&quot;Can&#x27;t reset method: already connected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// This restriction will prevent people from using this class to</span></span><br><span class="line">        <span class="comment">// experiment w/ new HTTP methods using java.  But it should</span></span><br><span class="line">        <span class="comment">// be placed for security - the request String could be</span></span><br><span class="line">        <span class="comment">// arbitrarily long.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (methods[i].equals(method)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (method.equals(<span class="string">&quot;TRACE&quot;</span>)) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;removal&quot;)</span></span><br><span class="line">                    <span class="type">SecurityManager</span> <span class="variable">s</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">                    <span class="keyword">if</span> (s != <span class="literal">null</span>) &#123;</span><br><span class="line">                        s.checkPermission(<span class="keyword">new</span> <span class="title class_">NetPermission</span>(<span class="string">&quot;allowHttpTrace&quot;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">this</span>.method = method;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ProtocolException</span>(<span class="string">&quot;Invalid HTTP method: &quot;</span> + method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>试过 <code>X-Method-Override</code> 也不好使，于是部分 PATCH 的接口改用 okhttp3</p><hr><p>今天重新测试的时候，发现登录接口不好使了，因为登录是一条 Auth0 的链接，<code>https://auth0.xxx.com/authorize?client_id=xxx&amp;scope=openid%20email%20profile</code>，scope 里面的值是有空格分开的</p><p><img src="/2023/02/22/jsoup1-15-4%E5%A5%87%E6%80%AAbug%E6%8E%92%E6%9F%A5/1.png"></p><p>‘%’ 也会被转码</p><p><img src="/2023/02/22/jsoup1-15-4%E5%A5%87%E6%80%AAbug%E6%8E%92%E6%9F%A5/2.png"></p><p><img src="/2023/02/22/jsoup1-15-4%E5%A5%87%E6%80%AAbug%E6%8E%92%E6%9F%A5/3.png"></p><p>在 1.15.3 里面正常，在 1.15.4 里会把 <code>%20</code> 里面的 <code>%</code> 也重新编码，导致出现 <code>%2520</code>，服务器就报错了</p><p><img src="/2023/02/22/jsoup1-15-4%E5%A5%87%E6%80%AAbug%E6%8E%92%E6%9F%A5/4.png"></p><p>获取不到 state，无法登录系统</p><p><img src="/2023/02/22/jsoup1-15-4%E5%A5%87%E6%80%AAbug%E6%8E%92%E6%9F%A5/5.png"></p><p>回滚后一切正常</p><p><img src="/2023/02/22/jsoup1-15-4%E5%A5%87%E6%80%AAbug%E6%8E%92%E6%9F%A5/6.png"></p><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;官方团队很快就修复了&quot;&gt;&lt;a href=&quot;#官方团队很快就修复了&quot; class=&quot;headerlink&quot; title=&quot;官方团队很快就修复了&quot;&gt;&lt;/a&gt;官方团队很快就修复了&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/jhy/jsoup/</summary>
      
    
    
    
    <category term="程序设计" scheme="https://linweiyuan.github.io/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    
    
    <category term="Java" scheme="https://linweiyuan.github.io/tags/Java/"/>
    
    <category term="jsoup" scheme="https://linweiyuan.github.io/tags/jsoup/"/>
    
  </entry>
  
  <entry>
    <title>ChatGPT如何教我写Python</title>
    <link href="https://linweiyuan.github.io/2023/02/21/ChatGPT%E5%A6%82%E4%BD%95%E6%95%99%E6%88%91%E5%86%99Python.html"/>
    <id>https://linweiyuan.github.io/2023/02/21/ChatGPT%E5%A6%82%E4%BD%95%E6%95%99%E6%88%91%E5%86%99Python.html</id>
    <published>2023-02-21T16:30:34.000Z</published>
    <updated>2023-03-26T01:20:45.346Z</updated>
    
    <content type="html"><![CDATA[<p>有时候并不是不会一样东西，只是不熟悉语法，比如广州去北京，大家都知道往北，但是需要一个导航才能去；比如英语口语，到嘴边了不知道怎么表达出来</p><p>ChatGPT 就是这样一个帮手</p><div>  <video-js id="videojs-id-e678c6c1-6c60-49cf-b00e-4ddf723c6ebb"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/chatgpt-teach-python/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojside678c6c16c6049cfb00e4ddf723c6ebb = videojs('videojs-id-e678c6c1-6c60-49cf-b00e-4ddf723c6ebb', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;有时候并不是不会一样东西，只是不熟悉语法，比如广州去北京，大家都知道往北，但是需要一个导航才能去；比如英语口语，到嘴边了不知道怎么表达出来&lt;/p&gt;
&lt;p&gt;ChatGPT 就是这样一个帮手&lt;/p&gt;
&lt;div&gt;
  &lt;video-js id=&quot;videojs-id-e678c6</summary>
      
    
    
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/categories/ChatGPT/"/>
    
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/tags/ChatGPT/"/>
    
    <category term="Python" scheme="https://linweiyuan.github.io/tags/Python/"/>
    
    <category term="Selenium" scheme="https://linweiyuan.github.io/tags/Selenium/"/>
    
  </entry>
  
  <entry>
    <title>Unity练习时长两天半</title>
    <link href="https://linweiyuan.github.io/2023/02/12/Unity%E7%BB%83%E4%B9%A0%E6%97%B6%E9%95%BF%E4%B8%A4%E5%A4%A9%E5%8D%8A.html"/>
    <id>https://linweiyuan.github.io/2023/02/12/Unity%E7%BB%83%E4%B9%A0%E6%97%B6%E9%95%BF%E4%B8%A4%E5%A4%A9%E5%8D%8A.html</id>
    <published>2023-02-12T16:10:52.000Z</published>
    <updated>2023-03-26T01:20:45.354Z</updated>
    
    <content type="html"><![CDATA[<p>精神状态不用怀疑，很正常</p><div>  <video-js id="videojs-id-99d218a0-fa72-4685-a248-4db63cfcfa9e"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/unity-practice-demo/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsid99d218a0fa724685a2484db63cfcfa9e = videojs('videojs-id-99d218a0-fa72-4685-a248-4db63cfcfa9e', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;精神状态不用怀疑，很正常&lt;/p&gt;
&lt;div&gt;
  &lt;video-js id=&quot;videojs-id-99d218a0-fa72-4685-a248-4db63cfcfa9e&quot; 
    class=&quot;vjs-default-skin vjs-16-9&quot; 
    contr</summary>
      
    
    
    
    <category term="Unity" scheme="https://linweiyuan.github.io/categories/Unity/"/>
    
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="Unity" scheme="https://linweiyuan.github.io/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>ChatGPT</title>
    <link href="https://linweiyuan.github.io/2023/02/08/ChatGPT.html"/>
    <id>https://linweiyuan.github.io/2023/02/08/ChatGPT.html</id>
    <published>2023-02-08T05:36:55.000Z</published>
    <updated>2023-03-26T01:20:45.346Z</updated>
    
    <content type="html"><![CDATA[<p>以下文章内容是和 ChatGPT 对话出来的</p><h4 id="介绍一下-ChatGPT"><a href="#介绍一下-ChatGPT" class="headerlink" title="介绍一下 ChatGPT"></a>介绍一下 ChatGPT</h4><p>ChatGPT 是由 OpenAI 开发的一种大型语言模型。它是基于 Transformer 架构的，并且经过了大量的训练，以生成自然语言文本。ChatGPT 被设计用来进行对话，因此具有很高的语言理解能力和文本生成能力。它可以用来回答问题、生成文本、进行翻译等等。</p><h4 id="继续"><a href="#继续" class="headerlink" title="继续"></a>继续</h4><p>ChatGPT 的训练数据来自互联网上的大量文本，因此它具有广泛的知识基础。在训练过程中，ChatGPT 学会了如何生成自然语言文本，并且可以理解上下文，因此它可以生成很多人类可以理解的文本。此外，ChatGPT 还具有非常高的语言处理速度，因此它可以在短时间内处理大量文本。总之，ChatGPT 是一个非常强大的语言模型，可以用来解决各种自然语言处理问题。</p><h4 id="继续-1"><a href="#继续-1" class="headerlink" title="继续"></a>继续</h4><p>ChatGPT 的应用非常广泛，它可以用来做聊天机器人、问答系统、文本生成、翻译、情感分析等等。此外，由于它具有高效的语言处理能力，因此它还可以用来做自动文本摘要、自动文档分类等。在许多场景中，ChatGPT 可以作为一个自然语言处理的解决方案，以帮助人们解决各种语言处理问题。总之，ChatGPT 是一个非常有价值的工具，可以用来解决各种自然语言处理问题。</p><h4 id="说多点"><a href="#说多点" class="headerlink" title="说多点"></a>说多点</h4><p>除了以上提到的应用以外，ChatGPT 还可以用来做语音识别、文本标注、文本分类等等。它的语言生成能力也可以用来生成代码、生成音乐、生成图片等。此外，ChatGPT 还可以用来做数据分析、智能客服、商业智能等。由于它具有高效的语言处理能力和广泛的知识基础，因此它可以作为一个非常有用的工具，帮助人们解决各种语言处理问题。总的来说，ChatGPT 是一个非常强大的语言模型，具有广泛的应用前景。</p><h4 id="可以用来干嘛"><a href="#可以用来干嘛" class="headerlink" title="可以用来干嘛"></a>可以用来干嘛</h4><p>ChatGPT 可以用来解决许多自然语言处理任务，包括但不限于：</p><ul><li>聊天机器人：可以与用户进行自然语言交互，解答他们的问题。</li><li>问答系统：可以根据用户的问题生成相应的答案。</li><li>文本生成：可以根据给定的模板或者提示生成人类可以理解的文本。</li><li>翻译：可以将一种语言翻译为另一种语言。</li><li>情感分析：可以对文本进行情感分析，以确定文本是正面、负面或中性。</li><li>自动文本摘要：可以根据文本的主题和内容自动生成摘要。</li><li>文本分类：可以对文本进行分类，将它们归入不同的类别中。</li><li>数据分析：可以根据数据生成图表和报告。</li><li>智能客服：可以与客户进行自然语言交互，帮助他们解决问题。</li><li>商业智能：可以帮助企业做数据分析和决策支持。</li></ul><p>总的来说，ChatGPT 可以用来解决大量的自然语言处理问题，并且因其快速、高效的语言处理能力而受到广泛的关注和应用。</p><h4 id="会替换掉程序员吗"><a href="#会替换掉程序员吗" class="headerlink" title="会替换掉程序员吗"></a>会替换掉程序员吗</h4><p>不是的，ChatGPT 并不能替换程序员。虽然 ChatGPT 是一个强大的自然语言处理模型，但它并不能完全替代程序员的工作。程序员仍然需要创建、设计和实现应用程序。他们还需要构建并维护后台系统，提供安全性和数据隐私保护等功能。</p><p>此外，ChatGPT 只是一种工具，它需要由程序员使用并进行集成，以实现其全部功能。程序员仍然是必要的，因为他们需要定义如何使用 ChatGPT，以及如何将它与其他系统和工具进行集成，以实现实际应用程序。</p><p>总的来说，ChatGPT 可以与程序员合作，帮助他们解决自然语言处理问题，但它不能替代程序员的工作。</p><h4 id="收费吗"><a href="#收费吗" class="headerlink" title="收费吗"></a>收费吗</h4><p>是的，使用 ChatGPT 是需要收费的。OpenAI 以 API 形式提供 ChatGPT，并对 API 调用收取计费。具体的计费标准和计费方式取决于你的使用情况，例如 API 调用的数量和频率。如果您对计费标准有兴趣，请前往 OpenAI 的官方网站查询详情。</p><h4 id="底层实现原理是什么"><a href="#底层实现原理是什么" class="headerlink" title="底层实现原理是什么"></a>底层实现原理是什么</h4><p>ChatGPT 的底层实现原理是基于 transformer 模型的预训练语言模型。</p><p>Transformer 模型是一种用于自然语言处理的神经网络模型，它的主要特点是通过注意力机制来关注输入中重要的单词和词组，以便于生成准确的预测。</p><p>在预训练阶段，ChatGPT 模型被训练在大量的文本数据上，以学习自然语言的语法和语义。在训练过程中，模型学习了如何生成合理的文本响应，如回答问题、生成摘要等。</p><p>在应用阶段，用户可以输入一个问题或请求，ChatGPT 模型将在其内部的语言表示中对输入进行编码，并生成对应的输出。</p><p>总的来说，ChatGPT 是一个通过大量数据预训练和深度学习技术实现的语言生成模型，它通过编码和生成语言来回答问题和生成文本内容。</p><h4 id="会替换传统工作吗"><a href="#会替换传统工作吗" class="headerlink" title="会替换传统工作吗"></a>会替换传统工作吗</h4><p>不一定会完全替代传统工作，但是 AI 技术，包括语言模型如 ChatGPT，确实可以自动完成一些传统工作中的任务，并以更高的效率和准确性完成这些任务。</p><p>例如，ChatGPT 可以帮助生成文本内容，比如文章摘要、新闻报道等，从而减少了人工工作量。同时，ChatGPT 还可以帮助自动回答问题，比如帮助客户服务代表解答客户问题等。</p><p>然而，ChatGPT 和其他 AI 技术仍需要由人类进行监督和管理，并且在某些情况下，人类仍然是不可替代的。因此，虽然 AI 技术可以帮助减少一些人工工作，但它不能完全替代人类。</p><h4 id="会进化成天网吗"><a href="#会进化成天网吗" class="headerlink" title="会进化成天网吗"></a>会进化成天网吗</h4><p>不存在“天网”这个东西，它是电影《终结者 2：审判日》中的一个虚构概念。但是，如果您指的是是否存在 AI 变得过于强大并对人类造成威胁的风险，那么这是一个值得关注的问题。</p><p>目前，AI 技术仍需要由人类进行监督和管理，并且 AI 的行为受到人类的限制和控制。同时，在 AI 研究和开发的过程中，也需要遵守道德和伦理准则，以确保 AI 的安全和健康使用。</p><p>因此，ChatGPT 不会变得过于强大并对人类造成威胁。但是，我们仍需要警惕 AI 的风险，并努力确保 AI 的安全和健康使用。</p><h4 id="会按下核弹发射按钮吗"><a href="#会按下核弹发射按钮吗" class="headerlink" title="会按下核弹发射按钮吗"></a>会按下核弹发射按钮吗</h4><p>不会，因为 ChatGPT 是一种人工智能模型，它没有实际的动作能力。它仅仅是一种语言生成模型，可以根据输入的文本生成相应的输出，但它不具有控制实际设备的能力。</p><p>此外，与核武器有关的决策通常需要经过多层安全检查和严格的审查程序，并由政府军事人员和安全专家进行控制。因此，我们可以确信，ChatGPT 无法按下核弹发射按钮。</p><hr><p>还有其他的省略掉了</p><p>总的来说，相比冷冰冰的搜索引擎，ChatGPT 更像一个平时生活中的人，问他问题总能比较有逻辑地精炼出解决的答案，当然不一定正确，这时如果提出疑问，他也会反思自己的答案有哪里出现不足，然后给出修改后的答案</p><p>缺点就是目前相对英文，中文提问回答较卡</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;以下文章内容是和 ChatGPT 对话出来的&lt;/p&gt;
&lt;h4 id=&quot;介绍一下-ChatGPT&quot;&gt;&lt;a href=&quot;#介绍一下-ChatGPT&quot; class=&quot;headerlink&quot; title=&quot;介绍一下 ChatGPT&quot;&gt;&lt;/a&gt;介绍一下 ChatGPT&lt;/h4&gt;&lt;p&gt;</summary>
      
    
    
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/categories/ChatGPT/"/>
    
    
    <category term="ChatGPT" scheme="https://linweiyuan.github.io/tags/ChatGPT/"/>
    
  </entry>
  
  <entry>
    <title>Effective Java</title>
    <link href="https://linweiyuan.github.io/2023/01/01/Effective-Java.html"/>
    <id>https://linweiyuan.github.io/2023/01/01/Effective-Java.html</id>
    <published>2023-01-01T08:14:46.000Z</published>
    <updated>2023-03-26T01:20:45.346Z</updated>
    
    <content type="html"><![CDATA[<p>目录，有改动</p><h3 id="创建和销毁对象"><a href="#创建和销毁对象" class="headerlink" title="创建和销毁对象"></a>创建和销毁对象</h3><ul><li>考虑用静态工厂方法代替构造器</li><li>遇到多个构造器参数时考虑用构造器</li><li>用私有构造器或枚举类型强化 Singleton 属性</li><li>通过私有构造器强化不可实例化的能力</li><li>避免创建不必要的对象</li><li>消除过期的对象引用</li><li>避免使用终结方法</li></ul><h3 id="对于所有对象都通用的方法"><a href="#对于所有对象都通用的方法" class="headerlink" title="对于所有对象都通用的方法"></a>对于所有对象都通用的方法</h3><ul><li>重写 equals 时遵守通用约定</li><li>重写 equals 时记得重写 hashCode</li><li>始终要重写 toString</li><li>谨慎地重写 clone</li><li>考虑实现 Comparator 接口</li></ul><h3 id="类和接口"><a href="#类和接口" class="headerlink" title="类和接口"></a>类和接口</h3><ul><li>使类和成员的可访问性最小化</li><li>在公有类中访问 public 方法而非直接访问 public 属性</li><li>使可变性最小化</li><li>复合优先于继承</li><li>要么为继承而设计，并提供文档说明，要么就禁止继承</li><li>接口优先于抽象类</li><li>接口只用于定义类型</li><li>类层次优先于标签类</li><li>用函数对象表示策略</li><li>优先考虑静态成员类</li></ul><h3 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h3><ul><li>请不要在新代码中使用原生态类型</li><li>消除非受检警告</li><li>集合优先于数组</li><li>优先考虑泛型</li><li>优先考虑泛型方法</li><li>利用有限制通配符来提升 API 的灵活性</li><li>优先考虑类型安全的异构容器</li></ul><h3 id="枚举和注解"><a href="#枚举和注解" class="headerlink" title="枚举和注解"></a>枚举和注解</h3><ul><li>用 enum 代替 int 常量</li><li>用实例域代替序数</li><li>用 EnumSet 代替位域</li><li>用 EnumMap 代替序数索引</li><li>用接口模拟可伸缩的枚举</li><li>注解优先于命名模式</li><li>坚持使用 Override 注解</li><li>用标记接口定义类型</li></ul><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><ul><li>检查参数的有效性</li><li>必要时进行保护性拷贝</li><li>谨慎设计方法签名</li><li>慎用重载</li><li>慎用可变参数</li><li>返回零长度的数组或者集合，而不是 null</li><li>为所有导出的 API 元素编写文档注释</li></ul><h3 id="通用程序设计"><a href="#通用程序设计" class="headerlink" title="通用程序设计"></a>通用程序设计</h3><ul><li>将局部变量的作用域最小化</li><li>for-each 循环优先于传统的 for 循环</li><li>了解和使用类库</li><li>如果需要精确的答案，避免使用 float 和 double</li><li>基本类型优先于装箱基本类型</li><li>如果其他类型更适合，尽量避免使用字符串</li><li>当心字符串连接的性能</li><li>通过接口引用对象</li><li>接口优先于反射机制</li><li>谨慎地使用本地方法</li><li>谨慎地进行优化</li><li>遵守普遍接受的命名惯例</li></ul><h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><ul><li>只针对异常的情况才使用异常</li><li>对可恢复的情况使用受检异常，对编程错误使用运行时异常</li><li>避免不必要地使用受检的异常</li><li>优先使用标准的异常</li><li>抛出与抽象相对应的异常</li><li>每个方法抛出的异常都要有文档</li><li>在细节消息中包含能捕获失败的信息</li><li>努力使失败保持原子性</li><li>不要忽略异常</li></ul><h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><ul><li>同步访问共享的可变数据</li><li>避免过度同步</li><li>executor 和 task 优先于线程</li><li>并发工具优先于 wait 和 notify</li><li>线程安全性的文档化</li><li>慎用延迟初始化</li><li>不要依赖于线程调度器</li><li>避免使用线程组</li></ul><h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><ul><li>谨慎地实现 Serializable 接口</li><li>考虑使用自定义的序列化形式</li><li>保护性地编写 readObject 方法</li><li>对于实例控制，枚举类型优先于 readResolve</li><li>考虑用序列化代理代替序列化实例</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;目录，有改动&lt;/p&gt;
&lt;h3 id=&quot;创建和销毁对象&quot;&gt;&lt;a href=&quot;#创建和销毁对象&quot; class=&quot;headerlink&quot; title=&quot;创建和销毁对象&quot;&gt;&lt;/a&gt;创建和销毁对象&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;考虑用静态工厂方法代替构造器&lt;/li&gt;
&lt;li&gt;遇到多个构造</summary>
      
    
    
    
    <category term="程序设计" scheme="https://linweiyuan.github.io/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    
    
    <category term="Java" scheme="https://linweiyuan.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>virt-manager安装Windows 11</title>
    <link href="https://linweiyuan.github.io/2022/12/16/virt-manager%E5%AE%89%E8%A3%85Windows-11.html"/>
    <id>https://linweiyuan.github.io/2022/12/16/virt-manager%E5%AE%89%E8%A3%85Windows-11.html</id>
    <published>2022-12-16T08:37:08.000Z</published>
    <updated>2023-03-26T01:20:45.358Z</updated>
    
    <content type="html"><![CDATA[<p>用 virt manager 安装 Windows 需要注意的事项：</p><ul><li>系统 CPU 和内存尽量设置大点</li><li>要选择 UEFI 方式启动</li><li>需要加个 TPM 模块，虚拟的即可</li></ul><div>  <video-js id="videojs-id-d8260c5d-9479-42bd-ba7c-99dee957b21e"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/virt-manager-install-windows-11/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsidd8260c5d947942bdba7c99dee957b21e = videojs('videojs-id-d8260c5d-9479-42bd-ba7c-99dee957b21e', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;用 virt manager 安装 Windows 需要注意的事项：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;系统 CPU 和内存尽量设置大点&lt;/li&gt;
&lt;li&gt;要选择 UEFI 方式启动&lt;/li&gt;
&lt;li&gt;需要加个 TPM 模块，虚拟的即可&lt;/li&gt;
&lt;/ul&gt;
&lt;div&gt;
  &lt;vi</summary>
      
    
    
    
    <category term="虚拟机" scheme="https://linweiyuan.github.io/categories/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="KVM" scheme="https://linweiyuan.github.io/tags/KVM/"/>
    
    <category term="QEMU" scheme="https://linweiyuan.github.io/tags/QEMU/"/>
    
  </entry>
  
  <entry>
    <title>橄榄镇与希望的大地商店物品修改（yuzu）</title>
    <link href="https://linweiyuan.github.io/2022/12/10/%E6%A9%84%E6%A6%84%E9%95%87%E4%B8%8E%E5%B8%8C%E6%9C%9B%E7%9A%84%E5%A4%A7%E5%9C%B0%E5%95%86%E5%BA%97%E7%89%A9%E5%93%81%E4%BF%AE%E6%94%B9%EF%BC%88yuzu%EF%BC%89.html"/>
    <id>https://linweiyuan.github.io/2022/12/10/%E6%A9%84%E6%A6%84%E9%95%87%E4%B8%8E%E5%B8%8C%E6%9C%9B%E7%9A%84%E5%A4%A7%E5%9C%B0%E5%95%86%E5%BA%97%E7%89%A9%E5%93%81%E4%BF%AE%E6%94%B9%EF%BC%88yuzu%EF%BC%89.html</id>
    <published>2022-12-10T13:12:56.000Z</published>
    <updated>2023-03-26T01:20:45.374Z</updated>
    
    <content type="html"><![CDATA[<p>GitHub: <a href="https://github.com/linweiyuan/switch-olive-town-shop-hack">https://github.com/linweiyuan/switch-olive-town-shop-hack</a></p><p>挖宝石本来就是看人品，耗时间，动不动还要 N 个，不能忍，写了个程序来修改商店物品数据</p><p><img src="/2022/12/10/%E6%A9%84%E6%A6%84%E9%95%87%E4%B8%8E%E5%B8%8C%E6%9C%9B%E7%9A%84%E5%A4%A7%E5%9C%B0%E5%95%86%E5%BA%97%E7%89%A9%E5%93%81%E4%BF%AE%E6%94%B9%EF%BC%88yuzu%EF%BC%89/1.png"></p><p><img src="/2022/12/10/%E6%A9%84%E6%A6%84%E9%95%87%E4%B8%8E%E5%B8%8C%E6%9C%9B%E7%9A%84%E5%A4%A7%E5%9C%B0%E5%95%86%E5%BA%97%E7%89%A9%E5%93%81%E4%BF%AE%E6%94%B9%EF%BC%88yuzu%EF%BC%89/2.png"></p><p><img src="/2022/12/10/%E6%A9%84%E6%A6%84%E9%95%87%E4%B8%8E%E5%B8%8C%E6%9C%9B%E7%9A%84%E5%A4%A7%E5%9C%B0%E5%95%86%E5%BA%97%E7%89%A9%E5%93%81%E4%BF%AE%E6%94%B9%EF%BC%88yuzu%EF%BC%89/3.png"></p><p>视频本来发在其他视频网站，但是后面审核太恶心，我删号了，所以没简介，但是字幕烧进去去不掉了</p><div>  <video-js id="videojs-id-beaab4ef-53de-4e5d-a9d3-e38b5a875f71"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/virt-manager-install-windows-11/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsidbeaab4ef53de4e5da9d3e38b5a875f71 = videojs('videojs-id-beaab4ef-53de-4e5d-a9d3-e38b5a875f71', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;GitHub: &lt;a href=&quot;https://github.com/linweiyuan/switch-olive-town-shop-hack&quot;&gt;https://github.com/linweiyuan/switch-olive-town-shop-hack&lt;/a&gt;</summary>
      
    
    
    
    <category term="游戏" scheme="https://linweiyuan.github.io/categories/%E6%B8%B8%E6%88%8F/"/>
    
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="Switch" scheme="https://linweiyuan.github.io/tags/Switch/"/>
    
    <category term="yuzu" scheme="https://linweiyuan.github.io/tags/yuzu/"/>
    
    <category term="橄榄镇与希望的大地" scheme="https://linweiyuan.github.io/tags/%E6%A9%84%E6%A6%84%E9%95%87%E4%B8%8E%E5%B8%8C%E6%9C%9B%E7%9A%84%E5%A4%A7%E5%9C%B0/"/>
    
  </entry>
  
  <entry>
    <title>虚拟机显卡直通 (PCI passthrough via OVMF)</title>
    <link href="https://linweiyuan.github.io/2022/11/25/%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A-PCI-passthrough-via-OVMF.html"/>
    <id>https://linweiyuan.github.io/2022/11/25/%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A-PCI-passthrough-via-OVMF.html</id>
    <published>2022-11-25T02:23:36.000Z</published>
    <updated>2023-03-26T01:20:45.378Z</updated>
    
    <content type="html"><![CDATA[<p>虚拟机对显卡的支持一向并不是非常完美，比如 VirtualBox 虚拟机设置，显存部分一般最多拉到 128MB，是虚拟的，无法用物理机的显卡，哪怕这张显卡是闲置的</p><p>VMware 很久没用了，据我所知，也是不支持物理显卡（这里不考虑企业级软件）</p><p>而 KVM + QEMU 却可以通过 PCI passthrough 的方式将物理机的显卡直通给虚拟机用，非常厉害</p><h1 id="前提准备"><a href="#前提准备" class="headerlink" title="前提准备"></a>前提准备</h1><p>下面所有操作都是基于 Arch Linux，其他系统未测试，未来也不会测试</p><p>因为本质上还是虚拟机，所以要确保 BIOS 设置好了开启虚拟化</p><p>接着就是要开启 IOMMU，这个也要硬件的支持</p><ul><li>如果是 Intel 的 CPU，修改内核参数 <code>intel_iommu=on iommu=pt</code></li><li>如果是 AMD 的 CPU，默认就有一些设置，因此只需加 <code>iommu=pt</code>（Yes？）</li></ul><p>修改完内核参数要重新跑 <code>sudo grub-mkconfig -o /boot/grub/grub.cfg</code>，重启生效</p><p>然后就是要拿到硬件的一些 id，这些 id 将会作为硬件的唯一标识在直通的过程中被使用到（这个脚本可以在 Arch Wiki 找到）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">shopt</span> -s nullglob</span><br><span class="line"><span class="keyword">for</span> g <span class="keyword">in</span> $(find /sys/kernel/iommu_groups/* -maxdepth 0 -<span class="built_in">type</span> d | <span class="built_in">sort</span> -V); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;IOMMU Group <span class="variable">$&#123;g##*/&#125;</span>:&quot;</span></span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> <span class="variable">$g</span>/devices/*; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;\t<span class="subst">$(lspci -nns $&#123;d##*/&#125;)</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span>;</span><br><span class="line"><span class="keyword">done</span>;</span><br></pre></td></tr></table></figure><p>PCI passthrough 的处理是通过将显卡从你的宿主机隔离出来，其中又有多种处理方式</p><h1 id="多显卡"><a href="#多显卡" class="headerlink" title="多显卡"></a>多显卡</h1><p>如果你的电脑是多显卡，并且 Linux 系统没有独显需求，就可以使用这种方法</p><p>这种情况多数出现在笔记本，当然台式机也有，只是很多 CPU 型号都把核显砍了</p><p>如果有独显，CPU 里又已经有核显了，厂商会进行一些优化，平时用核显，但是当有专业需求的时候，走的就是独显；自己也可以通过 Optimus 或者 Bumblebee 来进行控制</p><p>我的笔记本之前只拿来写写 Java，就是用 nvidia-xrun 把整个独显都禁用掉，neofetch 也查不到，相当于不通电，这样来稍微省点电池消耗</p><p>如果宿主机跑的是 Linux，虚拟机跑的是 Windows，那就可以通过这种方式来进行设置</p><p>这种方法可以实现物理机和虚拟机同时存在，物理机显示用核显，因为都不用独显了，所以可以在物理机系统启动时就把显卡隔离出来，这个就需要修改 Linux 内核参数</p><p>将上面准备阶段拿到的 id，写进内核参数 <code>vfio-pci.ids=xxx</code>，也要重新生成 grub 配置，也是重启生效</p><p>接着修改 <code>/etc/modprobe.d/vfio.conf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MODULES=(... vfio_pci vfio vfio_iommu_type1 vfio_virqfd ...)</span><br><span class="line">...</span><br><span class="line">HOOKS=(... modconf ...)</span><br></pre></td></tr></table></figure><p>修改完这个后也要重新生成 <code>sudo mkinitcpio -p linux</code>，同样是重启生效</p><p>然后多显卡的前提配置就完成了</p><h1 id="单显卡"><a href="#单显卡" class="headerlink" title="单显卡"></a>单显卡</h1><p>单显卡有点特殊，物理机输出到显示器也要显卡，所以不能提前将其隔离</p><p>QEMU 提供了一个 <code>hook</code> 功能，当虚拟机执行到某个阶段时，可以执行一些特定的脚本</p><p>因此思路就有了</p><ul><li>系统开机，正常使用显卡显示</li><li>开启虚拟机时，执行 hook，释放掉占用的资源，将显卡在物理机上隔离出来</li><li>关闭虚拟机时，执行 hook，重新把显卡模块启用，开启 DM</li></ul><p>首先 id 要写在一个单独配置文件 <code>/etc/modprobe.d/vfio.conf</code> 里，这个起到的作用就是可以动态进行模块的加载</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options vfio-pci ids=xxx</span><br></pre></td></tr></table></figure><p>接着要准备好 hook 脚本，路径是 <code>/etc/libvirt/hooks/qemu</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">OBJECT=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">OPERATION=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$OBJECT</span> == <span class="string">&quot;win10&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$OPERATION</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    <span class="string">&quot;prepare&quot;</span>)</span><br><span class="line">      prepare.sh 2&gt;&amp;1 | <span class="built_in">tee</span> -a /var/log/libvirt/hooks.log</span><br><span class="line">      ;;</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;release&quot;</span>)</span><br><span class="line">      release.sh 2&gt;&amp;1 | <span class="built_in">tee</span> -a /var/log/libvirt/hooks.log</span><br><span class="line">      ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>这里的 <code>win10</code> 是虚拟机的名称</p><p>开启虚拟机的监听脚本 <code>prepare.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">systemctl stop lightdm</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> efi-framebuffer.0 &gt; /sys/bus/platform/drivers/efi-framebuffer/unbind</span><br><span class="line"></span><br><span class="line">modprobe -r nvidia_drm</span><br><span class="line">modprobe -r nvidia_modeset</span><br><span class="line">modprobe -r nvidia_uvm</span><br><span class="line">modprobe -r nvidia</span><br><span class="line"></span><br><span class="line">virsh nodedev-detach pci_0000_xxx</span><br><span class="line">virsh nodedev-detach pci_0000_xxx</span><br><span class="line"></span><br><span class="line">modprobe vfio_pci</span><br><span class="line">modprobe vfio</span><br><span class="line">modprobe vfio_iommu_type1</span><br><span class="line">modprobe vfio_virqfd</span><br></pre></td></tr></table></figure><p>其中的 <code>pci_0000_xxx</code> 是在查 id 的阶段拿到的，比如输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">06:00.0 VGA compatible controller [0300]: NVIDIA Corporation GA104 [GeForce RTX 3060 Ti] [10de:2486] (rev a1)</span><br></pre></td></tr></table></figure><p>则 <code>options vfio-pci ids=10de:2486</code>，<code>virsh nodedev-detach pci_0000_06_00_0</code></p><p>关闭虚拟机的监听脚本 <code>release.sh</code>，关闭其实就是一个反向的回滚操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">modprobe -r vfio_pci</span><br><span class="line">modprobe -r vfio</span><br><span class="line">modprobe -r vfio_iommu_type1</span><br><span class="line">modprobe -r vfio_virqfd</span><br><span class="line"></span><br><span class="line">virsh nodedev-reattach pci_0000_xxx</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> efi-framebuffer.0 &gt; /sys/bus/platform/drivers/efi-framebuffer/bind</span><br><span class="line"></span><br><span class="line">modprobe nvidia_drm</span><br><span class="line">modprobe nvidia_modeset</span><br><span class="line">modprobe nvidia_uvm</span><br><span class="line">modprobe nvidia</span><br><span class="line"></span><br><span class="line">systemctl start lightdm</span><br></pre></td></tr></table></figure><p>这些脚本需要在安装完系统后再设置，或者先换别的名字，不然安装的时候就会被执行，然后黑屏</p><p>这个就是单显卡的前提配置</p><h1 id="系统安装及测试"><a href="#系统安装及测试" class="headerlink" title="系统安装及测试"></a>系统安装及测试</h1><p>多显卡进行系统安装时可以直接把显卡设置进去</p><p>单显卡则不可以，需要先安装系统，如果显卡设置进去，那物理机也要用，虚拟机也要用，就会卡住</p><p>平时 Windows 在系统安装完成后会自动在系统更新那里帮用户安装好显卡驱动，但是显卡直通这种方式最好是手动进行安装，Windows 不一定识别得出来，安装完驱动后，一切都和正常使用就没什么区别了</p><div>  <video-js id="videojs-id-99888e5b-cdc2-4027-bab4-f881b189c754"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/nvidia-gpu-kvm-pci-passthrough/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsid99888e5bcdc24027bab4f881b189c754 = videojs('videojs-id-99888e5b-cdc2-4027-bab4-f881b189c754', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;虚拟机对显卡的支持一向并不是非常完美，比如 VirtualBox 虚拟机设置，显存部分一般最多拉到 128MB，是虚拟的，无法用物理机的显卡，哪怕这张显卡是闲置的&lt;/p&gt;
&lt;p&gt;VMware 很久没用了，据我所知，也是不支持物理显卡（这里不考虑企业级软件）&lt;/p&gt;
&lt;p&gt;而</summary>
      
    
    
    
    <category term="虚拟机" scheme="https://linweiyuan.github.io/categories/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="KVM" scheme="https://linweiyuan.github.io/tags/KVM/"/>
    
    <category term="QEMU" scheme="https://linweiyuan.github.io/tags/QEMU/"/>
    
    <category term="Nvidia" scheme="https://linweiyuan.github.io/tags/Nvidia/"/>
    
    <category term="VirtIO" scheme="https://linweiyuan.github.io/tags/VirtIO/"/>
    
  </entry>
  
  <entry>
    <title>分布式相关实践</title>
    <link href="https://linweiyuan.github.io/2022/11/05/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9B%B8%E5%85%B3%E5%AE%9E%E8%B7%B5.html"/>
    <id>https://linweiyuan.github.io/2022/11/05/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9B%B8%E5%85%B3%E5%AE%9E%E8%B7%B5.html</id>
    <published>2022-11-05T06:21:07.000Z</published>
    <updated>2023-03-26T01:20:45.358Z</updated>
    
    <content type="html"><![CDATA[<h1 id="分布式-ID"><a href="#分布式-ID" class="headerlink" title="分布式 ID"></a>分布式 ID</h1><p>ID 在大部分场景下，都是用来区分一条记录，因此天然要求唯一性，并且根据业务需求，有的还要求趋势递增。在单节点的数据库环境下，可以利用数据库自身具备的自增特性，比如 Oracle 的 sequence，MySQL 的 auto_increment，Postgres 的 serial 等，但是在分布式集群环境下，各个数据库都有自己维护的一套自增 ID，因此可能出现多个数据库都是 ID &#x3D; 1 的情况，这样就有问题，因此就有了分布式 ID，要求全局唯一，并且具备高性能高可用。下面是几种方案（不是全部）</p><ul><li><p>数据库自增 ID<br>抛开事实不谈，如果仅仅说实现方式，这也是一种方法。还是利用数据库的自增 ID 解决，不同的是要在集群前面额外搞一个实例充当“工具库”的角色，API 先从这里拿到最新自增 ID，在插入数据的时候顺便把这个 ID 也一起提交</p><p>缺点也是很明显，并且非常的非主流，正经人谁这么搞</p></li><li><p>UUID<br>UUID 实现起来非常简单，并且使用得当的话基本不会重复</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString(); <span class="comment">// 36</span></span><br><span class="line"><span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>); <span class="comment">// 32</span></span><br></pre></td></tr></table></figure><p>但是如果有需求说 ID 里面需要反映一些有意义的东西，比如订单号、时间戳等，这种方法就不适用</p><p>有好处吗？<br>有。这种 UUID 的方式在某种程度上可以防止一些越权的操作，比如 ID &#x3D; 1 是普通用户能看，ID &#x3D; 2 是超管才能看，那么如果 API 权限验证没处理好，可能普通用户就能看到超管的东西</p><p>坏处比好处多得多，比如 MySQL 特殊的数据结构，ID 在叶子节点上往往会有一个排序的操作，如果用 UUID，则每新增一条记录，都有可能会使得数据重新排序，影响性能</p></li><li><p>雪花算法<br>推特开源，通过多少位的时间戳 + 多少位的机器 ID + 多少位的序列号组成，详细的去看别人的文章</p><p>GitHub 上源码 <a href="https://github.com/twitter-archive/snowflake/tree/snowflake-2010">snowflake-2010</a> 在 10 年前就不更新了，除非手动调整机器时间，正常使用基本也不会重复<br>国内大厂则有其他类似的实现，比如百度的 <a href="https://github.com/baidu/uid-generator">UidGenerator</a>、滴滴的 <a href="https://github.com/didi/tinyid">Tinyid</a>、美团的 <a href="https://github.com/Meituan-Dianping/Leaf">Leaf</a></p></li><li><p>基于 Redis<br>主要用了 Redis 的 <code>INCRBY</code> 指令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INCRBY key increment</span><br></pre></td></tr></table></figure><p>Redis 由于自身的单线程特点（高版本有多线程，但是是用来做其他事情的），里面的操作具备原子性，因此可以利用这条指令，每次增加 1，则可完成分布式 ID 的自增，并且不重复</p><p>但是还是老话，凡是引入了其他中间件，都要考虑高可用问题，让它们不要挂。如果 ID 增长了，但没来得及刷盘 Redis 就挂掉了，下次起来时，可能 ID 就会重复。这个时候往往需要 RDB + AOF 配合使用，RDB 保证实例启动的速度，AOF 则确保数据的一致性；还有就是一主二从三哨兵那一套</p></li></ul><h1 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h1><p>单机事务的实现方式，通常是先把事务自动提交设置为 false，编写一堆逻辑，完了后手动 commit 或者 rollback<br>分布式事务主流的还是阿里的 Seata</p><p>Seata 里面有三个核心概念：</p><ul><li>Transaction Manager（事务管理器）：主要用来管理全局事务，需要单独部署一个 <code>seata-server</code> 的服务（支持 Nacos、Eureka、Redis、ZooKeeper 等多种注册中心，一般情况下，阿里系的东西多是配合 Nacos 使用，毕竟一家的），并且创建好全局事务和分支事务对应的表</li><li>Resource Manager（资源管理器）：主要用来管理分支事务</li><li>Transaction Coordinator（事务协调者）：类似警匪片中的谈判专家，维护全局事务和分支事务的状态，当事务提交或回滚的时候进行协调</li></ul><p>Seata 里面还有四种分布式事务解决方案：</p><ul><li>AT：Seata 默认模式，分阶段提交事务，但是在第一阶段就提交分支事务，那么回滚要怎么回滚呢？需要额外创建表，来记录数据修改前的状态，回滚时则进行和事务提交时相反的操作，达到最终一致；第一阶段无需锁定数据库资源，和下面的 XA 相比，性能好一点</li><li>XA：也是分阶段提交事务，第一阶段各个分支事务先准备，然后看结果返回就绪还是失败，如果就绪则在第二阶段提交事务，失败则回滚。这种模式，一般数据库都自带支持，所以实现起来比较简单，无需编写额外的代码或者建表；但是 XA 偏 CP，在第一阶段需要锁定数据库资源，强调强一致性，因此和上面的 AT 相比，性能较差，还牺牲了一定的可用性</li><li>TCC：同样是分阶段提交事务，分为 Try-Confirm-Cancel 三个阶段，需要额外的代码来处理对应业务逻辑。这样一来，在第一阶段就直接提交事务，性能比 XA 好，同时数据是通过代码来完成回滚的，无需建额外的表，比 AT 简单，并且由于事务都是由自己的代码来完成，对于不支持事务的存储引擎也可以使用。缺点就是需要自己额外写代码，并且考虑处理失败的情况，对人的要求就比较高了</li><li>SAGA：还是分阶段提交事务，一阶段直接提交事务，二阶段如果失败则通过代码来进行补偿操作，成功则什么都不做</li></ul><p>分布式事务，其实用得真不多，最多就是万一发生问题，通过日志排查来进行人工手动补偿，也有可能是用户量太少了，或 CRUD 做多了</p><h1 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h1><p>锁一般是用来解决多线程或者说高并发环境下共享变量的安全问题<br>当只有一个实例的时候，可以使用 <code>synchronized</code> 或者 <code>ReentrantLock</code> 等来进行加锁操作，但在多实例下，每个 JVM 进程都是独立的，单机锁就达不到想要的效果，因此大多都是需要借助第三方的力量，来提供一个全局加锁的功能</p><p>以最经典的抢票为例，多个人抢固定数量的票，如果处理得不得当，就会发生超卖的现象，是个人都提示抢到票，但实际上你的票并没有这么多，因为多线程下，总票数被频繁修改，没有安全保障</p><p>下面是常见的其中几种分布式锁解决方案</p><ul><li><p>MySQL 单条 update 语句<br>如果 JVM 存在多个，但是 MySQL 只有一个，这种算分布式吗？</p><p>当它算。由于 MySQL 只有一个，而 MySQL 在处理更新语句的时候，会默认进行一个加锁的操作，因此可以利用这种特性来充当分布式锁，比如下面的伪代码（不考虑边界问题）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> 表 <span class="keyword">set</span> 票数 <span class="operator">=</span> 票数 <span class="operator">-</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>当这个表存在多个列，并且需要充当查询条件的时候，需要注意索引的设置，比如</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> 表 <span class="keyword">set</span> 票数 <span class="operator">=</span> 票数 <span class="operator">-</span> <span class="number">1</span> <span class="keyword">where</span> 目的地 <span class="operator">=</span> xxx;</span><br></pre></td></tr></table></figure><p>此时如果目的地没有添加索引，MySQL 触发的是表锁，整个表都不可用，但是如果在目的地上添加了索引，则触发的会是行锁，仅仅锁住当前目的地的数据，这样就提高了性能</p><p>当然要正确使用查询条件，如果使用“目的地 !&#x3D; xxx”，那就算添加了索引，也会触发表锁，因为索引会失效<br>这种方式仅仅适用简单的业务逻辑，如果想在修改票数前后添加一些额外的处理，就不行了</p></li><li><p>MySQL select for update 语句<br>和上面的类似，只是执行 <code>select for update</code> 锁住了所查记录后，还可以进行一些额外的操作，完了后再执行 <code>update</code> 语句，相对来说就会更加灵活</p><p>缺点在后面跟着，复杂操作更要注意加解锁的处理，防止死锁</p></li><li><p>MySQL 乐观锁<br>乐观锁的实现思想基本都来源于 CAS（Compare And Swap），当实际的值与预期的值一致，才将旧值更新成新值，否则就自旋，也就是循环（期间可以设置短时间的 sleep，减少 CPU 的无效操作）。最常见的落地方案就是数据库表加多一个 <code>version</code> 字段</p><p>先把 version 查出来，最后执行更新操作的时候再判断现在的 version 值是否和开始查到的是否一致，如果不一致，那就是被别人改过了，那就重新再拿一遍，再修改</p><p>虽然一般都说加锁是重量级的操作，但是这种 CAS 虽然不用加锁，但是好多循环，也会占用无谓的 CPU 资源，有时性能反而不如悲观锁，所以实际使用最好自己测试一下</p></li><li><p>Redis 乐观锁<br>主要利用 Redis 的 <code>WATCH</code> + <code>MULTI</code> + <code>EXEC</code> 指令实现</p><p>当 WATCH 了某个 key，开启 MULTI 后，其他线程如果修改了这个 key 的值，那么最后执行 EXEC 的时候就会返回 nil，成功则返回 OK</p><p>这样就实现了类似 version 的效果，执行失败，自旋，然后重新执行即可</p><p><code>redis-cli</code> 里是这三条指令，那么对应到 Java 代码里会是简单的三条相加吗？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">redisTemplate.watch(key);</span><br><span class="line">redisTemplate.multi();</span><br><span class="line">redisTemplate.exec();</span><br></pre></td></tr></table></figure><p>不是。如果按照上面的用法会报 <code>ERR EXEC without MULTI</code>，明明有 <code>multi()</code>，但为什么还是报这个错？因为用法不对，正确的用法是这样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>&lt;&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">        operations.watch(key);</span><br><span class="line">        operations.multi();</span><br><span class="line">        <span class="keyword">return</span> operations.exec();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>Redis 分布式锁<br>利用 Redis 的 <code>SETNX</code> + <code>DEL</code> 指令实现，SETNX 进行 key 的设置的时候，如果这个 key 不存在，才会被设置，因此可以充当加锁操作；而解锁就仅仅需要把前面设置的 key 进行删除即可</p><p>SETNX 设置出来的属于独占锁（排他锁），一旦加锁成功，但是由于某些原因 API 挂了，这就会导致整个服务不可用，因为要解锁就必须先经过获取锁的那一步，而现在由于已经设置了锁，那就没办法再得到锁，因此没办法释放。所以需要给锁设置一个过期自动删除的时间</p><p>利用 Redis 的 <code>EXPIRE</code> 指令可以对 key 设置超时时间，完成上面的需求</p><p>Redis 还提供了 SETNX + EXPIRE 的组合指令，比如设置一个 10 秒过期的 key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET key value EX 10 NX</span><br></pre></td></tr></table></figure><p>其中 <code>EX</code> 表示秒，可换成 <code>PX</code> 表示毫秒；<code>NX</code> 表示不存在才设置，可换成 <code>XX</code> 表示存在才设置。由于是一条指令，因此具备原子性，对应到 Java 代码里则是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.opsForValue().set(key, value, <span class="number">10</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure><p>此时解决了一个问题，但是出现了新的问题</p><p>举个例子，假如 API 里设置了 10 秒过期自动释放锁，但是业务逻辑执行完需要 15 秒，此时执行到第 10 秒的时候，锁自动释放掉了，第二个线程拿到锁，但是前面的线程还没执行完，继续执行 5 秒后执行完毕，手动释放锁，这个时候的锁已经是第二个线程拿到的了，自己加的锁被别人释放了，这就有问题，因为释放锁的时候仅仅是执行一个删除 key 的操作，才不管这个锁是谁的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.delete(key);</span><br></pre></td></tr></table></figure><p>因此，需要加上一些判断，让自己的锁只有自己才能删</p><p>可能有人会想到说，既然要确保不能删除别人的锁，那是否让 key 每个线程不同就可以了？我删除的是 set 的时候生成的 key，如果删除了一个不存在的 key，就会失败，等于没删除</p><p>这也是正常人的思维，但是问题在于，每个 key 都不一样，起不到加锁的作用。因此不能在 key 上动手，而可以将矛盾转移到 value 上，比如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">redisTemplate.opsForValue().set(key, value, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (value.equals(redisTemplate.opsForValue().get(key))) &#123;</span><br><span class="line">    redisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就解决了自己加的锁只能自己删的问题</p><p>但是又引出了新的问题</p><p>当第一个线程进入 <code>if</code> 代码块，准备执行 <code>delete(key)</code> 的时候，刚好到了过期时间，key 被删了，刚好此时切到第二个线程拿到锁准备执行业务代码，刚好又切回第一个线程继续执行删除操作，就又造成了第二个线程的锁被第一个线程删掉。尽管通过 UUID 来确保了唯一性，但是进入 if 后，delete 操作还是只看 key，不管 UUID</p><p>原因在于，if 和 delete 操作不具备原子性，要解决这个问题，就需要借助 Redis 的 <code>EVAL</code> 指令来执行 <code>lua</code> 脚本</p><p>Redis 里面的操作具备原子性，因此 EVAL 指令具备原子性，因此执行 lua 脚本的操作也具备原子性，因此就算在脚本里写 N 行代码，还是具备原子性，因此可以在里面进行一些较为复杂的业务逻辑编写，因此可以把上面的判断搬进 lua 脚本里</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        if redis.call(&#x27;GET&#x27;, KEYS[1]) == ARGV[1]</span></span><br><span class="line"><span class="string">        then</span></span><br><span class="line"><span class="string">            return redis.call(&#x27;DEL&#x27;, KEYS[1])</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>;</span><br><span class="line">redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(lua, Boolean.class), List.of(key), value);</span><br></pre></td></tr></table></figure><p>这样就确保了自己的 key 只有自己能删</p><p>但是还是有其他问题在</p><p>如果一个请求里面执行的业务逻辑获取了锁，但是需要调用别的方法执行另外的逻辑，这个方法里面也要先获得锁才能执行，但是前面的操作已经获取过一次锁，既然在前面已经获取了锁，方法还没执行完就不会释放，这个时候调用另一个方法，这个方法又需要先获取锁才能执行，就出现了死锁。因此，对于同一个请求，要允许它重复获得锁，需要做一个可重入的处理，类似 <code>ReentrantLock</code></p><p>要实现可重入，就需要记下来获取锁的次数，每次获取到锁，次数 +1，随着方法的调用完毕出栈 -1，最后减到 0 删除 key，达到释放锁的效果。如果用上面的数据结构，因为 value 是 UUID，因此可以在后面拼一个次数，比如 UUID:1，这样也是一种方法。但是 Redis 其实提供了一种更加合适的数据结构 Hash，用 <code>HSET</code> + <code>HEXISTS</code> + <code>HINCRBY</code> 指令可完成类似于对象的存储（不是那种文件的对象存储）</p><p>因为需要提前判断 key 是否存在，不存在则进行设置，存在则需要判断当前的锁是不是自己的，如果是则更新获取锁次数，逻辑较为复杂，因此可以借助 lua 脚本来完成</p><p>加锁</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        if redis.call(&#x27;EXISTS&#x27;, KEYS[1]) == 0 or redis.call(&#x27;HEXISTS&#x27;, KEYS[1], ARGV[1]) == 1</span></span><br><span class="line"><span class="string">        then</span></span><br><span class="line"><span class="string">            redis.call(&#x27;HINCRBY&#x27;, KEYS[1], ARGV[1], 1)</span></span><br><span class="line"><span class="string">            return 1</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>;</span><br><span class="line">redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(lua, Boolean.class), List.of(key), value);</span><br></pre></td></tr></table></figure><p>解锁则进行相反的操作，当锁次数为 0 后，表示全部方法出栈，删除 key，否则就只是次数变化，加负数就是减法操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        if redis.call(&#x27;HEXISTS&#x27;, KEYS[1], ARGV[1]) == 0</span></span><br><span class="line"><span class="string">        then</span></span><br><span class="line"><span class="string">            return nil</span></span><br><span class="line"><span class="string">        elseif redis.call(&#x27;HINCRBY&#x27;, KEYS[1], ARGV[1], -1) == 0</span></span><br><span class="line"><span class="string">        then</span></span><br><span class="line"><span class="string">            return redis.call(&#x27;DEL&#x27;, KEYS[1])</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>;</span><br><span class="line">redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(lua, Boolean.class), List.of(key), value);</span><br></pre></td></tr></table></figure><p>这样就完成了可重入锁的设置</p><p>但是还有问题</p><p>由于设置了过期自动删除 key，因此可能出现业务还没执行完，就自动释放了锁，因此需要确保在代码的执行过程中，通过一些额外的操作来使这个 key 自动续期，达到永不过期的效果。在这个条件下，一旦业务没完成，就会一直自动续期，那么还需要设置过期时间吗？</p><p>需要。设置过期时间只是一个兜底的方案，理想情况下会是代码里进行加锁、解锁的操作，万一有故障发生，才会走超时自动释放锁的流程，防止死锁，所以两者并不冲突，反而相辅相成</p><p>为了完成这个操作，需要定期去判断 Redis 中是否还存在这个 key，存在则更新 key 的 <code>TTL</code>，最简单的就是利用 JDK 的 <code>Timer</code>，比如每隔 5 秒去更新下过期时间</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateTTL</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            if redis.call(&#x27;HEXISTS&#x27;, KEYS[1], ARGV[1]) == 1</span></span><br><span class="line"><span class="string">            then</span></span><br><span class="line"><span class="string">                return redis.call(&#x27;EXPIRE&#x27;, KEYS[1], 10)</span></span><br><span class="line"><span class="string">            else</span></span><br><span class="line"><span class="string">                return 0</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Timer</span>().schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> Boolean.TRUE.equals(redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(lua, Boolean.class), List.of(key), value));</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                updateTTL();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">5</span> * <span class="number">1000</span>); <span class="comment">// 只设置 delay，没设置 period，因此只是一次性任务，无需再额外进行 cancel() 操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取锁成功时，调用这个方法开启定时任务，后面就只需要递归调用，当锁释放时，由于定时器里面返回 false，因此也会自动结束</p><p>可重入锁，则也需要加上更新过期时间的逻辑处理，比如 10 秒</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis.call(&#x27;HINCRBY&#x27;, KEYS[1], ARGV[1], 1)</span><br><span class="line">redis.call(&#x27;EXPIRE&#x27;, KEYS[1], 10)</span><br></pre></td></tr></table></figure><p>这样就完成了自动续期，基本上满足大部分业务需求</p></li><li><p>Redlock<br>也直译成红锁，官方的一种 Redis 集群下的实现方式，文档：<a href="https://redis.io/docs/manual/patterns/distributed-locks">Distributed Locks with Redis</a></p><p>在集群的情况下，Redis 会分为主从节点，因为主从节点之间同步数据需要花费一定的时间，因此如果 API 在主节点中获取了锁，数据还没来得及同步到从节点，主节点挂了，哨兵机制会将从节点升级为主节点，如果 API 也是集群部署，则可能导致另一个实例能重新获取到新的锁，导致分布式锁失效</p><p>红锁的实现原理，简单来说就是，当获取锁的时候，从每个节点上都利用相同的 key 去获取，当超过 3 个以上节点获取锁成功（建议 5 个节点），才算成功。如果某个节点获取失败，则跳过，防止阻塞。另外再对在获取锁的过程中，和锁自动释放的时间进行一个处理，详细的话自己去看文档</p></li><li><p>Redisson<br>别人封装好的，用起来比较简单</p><p>其实去看里面的代码，核心部分也是通过 lua 脚本，和上面的差不多，只不过会做了一些不太容易看懂的优化，性能会更好，还有一些公平锁非公平锁的处理，比如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; RFuture&lt;T&gt; <span class="title function_">tryLockInnerAsync</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId, RedisStrictCommand&lt;T&gt; command)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> evalWriteAsync(getRawName(), LongCodec.INSTANCE, command,</span><br><span class="line">            <span class="string">&quot;if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return redis.call(&#x27;pttl&#x27;, KEYS[1]);&quot;</span>,</span><br><span class="line">            Collections.singletonList(getRawName()), unit.toMillis(leaseTime), getLockName(threadId));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> RFuture&lt;Boolean&gt; <span class="title function_">unlockInnerAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> evalWriteAsync(getRawName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,</span><br><span class="line">            <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[3]) == 0) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return nil;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;local counter = redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[3], -1); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;if (counter &gt; 0) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[2]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 0; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;del&#x27;, KEYS[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;publish&#x27;, KEYS[2], ARGV[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 1; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return nil;&quot;</span>,</span><br><span class="line">            Arrays.asList(getRawName(), getChannelName()), LockPubSub.UNLOCK_MESSAGE, internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有比较丰富的中文文档：<a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95">目录</a></p></li><li><p>ZooKeeper<br>ZooKeeper 的 ZNodes 在设计上来说就是不可重复的，并且 ZooKeeper 偏向 CP，强调数据的一致性； ZooKeeper 提供了监听节点的机制；ZooKeeper 可以创建临时顺序节点；上面种种特性加起来，也是很适合用来做分布式锁</p><p>当有请求要获取锁的时候，给它创建一个临时顺序节点，并且监听上一个节点，如果上一个节点没了，表明自己是最前上面的，表示获取锁成功，业务执行完毕后删除节点释放锁，这样下一个节点监听到，它就能获取锁，以此类推，直到所有请求处理完成</p><p>由于用了顺序节点，每个请求都会创建不同的节点，删除的时候就不会出现误删的情况</p><p>可重入锁的实现思想和其他的也类似，也是记录下线程（也就是当前请求）相关的东西，进行 +1、-1 的操作。线程隔离的东西就可以考虑使用 <code>ThreadLocal</code></p><p>而临时节点天然防死锁，当创建一个临时节点时，如果 API 挂了，API 与 ZooKeeper 之间的连接就会断开，而 ZooKeeper 检测到连接断开，就会自动将临时节点删除</p></li><li><p>Curator<br>别人封装好的 ZooKeeper 客户端</p></li></ul><p>未完待续</p><hr><p>相关链接：<a href="https://linweiyuan.github.io/2022/05/22/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9B%B8%E5%85%B3%E7%90%86%E8%AE%BA.html">分布式相关理论</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;分布式-ID&quot;&gt;&lt;a href=&quot;#分布式-ID&quot; class=&quot;headerlink&quot; title=&quot;分布式 ID&quot;&gt;&lt;/a&gt;分布式 ID&lt;/h1&gt;&lt;p&gt;ID 在大部分场景下，都是用来区分一条记录，因此天然要求唯一性，并且根据业务需求，有的还要求趋势递增。在单节</summary>
      
    
    
    
    <category term="架构设计" scheme="https://linweiyuan.github.io/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"/>
    
    
    <category term="分布式ID" scheme="https://linweiyuan.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8FID/"/>
    
    <category term="分布式锁" scheme="https://linweiyuan.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    
    <category term="分布式事务" scheme="https://linweiyuan.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>自定义starter处理异常和请求响应日志</title>
    <link href="https://linweiyuan.github.io/2022/10/15/%E8%87%AA%E5%AE%9A%E4%B9%89starter%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8%E5%92%8C%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94%E6%97%A5%E5%BF%97.html"/>
    <id>https://linweiyuan.github.io/2022/10/15/%E8%87%AA%E5%AE%9A%E4%B9%89starter%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8%E5%92%8C%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94%E6%97%A5%E5%BF%97.html</id>
    <published>2022-10-15T17:35:34.000Z</published>
    <updated>2023-03-26T01:20:45.378Z</updated>
    
    <content type="html"><![CDATA[<p>GitHub: <a href="https://github.com/linweiyuan/logger-spring-boot-starter">https://github.com/linweiyuan/logger-spring-boot-starter</a></p><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p><code>git clone https://github.com/linweiyuan/logger-spring-boot-starter.git</code></p><p><code>./gradlew publishToMavenLocal</code>（其实如果没有特殊的自定义构建脚本需求，感觉 maven 好很多，没有奇奇怪怪的问题）</p><h1 id="依赖处理"><a href="#依赖处理" class="headerlink" title="依赖处理"></a>依赖处理</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.linweiyuan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logger-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="异常日志处理"><a href="#异常日志处理" class="headerlink" title="异常日志处理"></a>异常日志处理</h1><p>启动类（或者其他叫法）添加 <code>@EnableExceptionLog</code> 注解</p><p>如果使用 <code>@EnableExceptionLog(allowOverride = true)</code>，注解上的配置就会失效，以配置文件为准，可以方便的进行修改而无需重新编译</p><p>支持如下属性</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">linweiyuan.logger.exception.border-color</span>=<span class="string">#ffffff</span></span><br><span class="line"><span class="attr">linweiyuan.logger.exception.border-background-color</span>=<span class="string">#ffffff</span></span><br><span class="line"><span class="attr">linweiyuan.logger.exception.border-blink</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">linweiyuan.logger.exception.text-color</span>=<span class="string">#ffffff</span></span><br><span class="line"><span class="attr">linweiyuan.logger.exception.text-background-color</span>=<span class="string">#ffffff</span></span><br><span class="line"><span class="attr">linweiyuan.logger.exception.text-bold</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">linweiyuan.logger.exception.text-italic</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">linweiyuan.logger.exception.text-blink</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">linweiyuan.logger.exception.empty-space-background-color</span>=<span class="string">#ffffff</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">linweiyuan:</span></span><br><span class="line">  <span class="attr">logger:</span></span><br><span class="line">    <span class="attr">exception:</span></span><br><span class="line">      <span class="attr">border-color:</span> <span class="string">&quot;#ffffff&quot;</span></span><br><span class="line">      <span class="attr">border-background-color:</span> <span class="string">&quot;#ffffff&quot;</span></span><br><span class="line">      <span class="attr">border-blink:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">text-color:</span> <span class="string">&quot;#ffffff&quot;</span></span><br><span class="line">      <span class="attr">text-background-color:</span> <span class="string">&quot;#ffffff&quot;</span></span><br><span class="line">      <span class="attr">text-bold:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">text-italic:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">text-blink:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">empty-space-background-color:</span> <span class="string">&quot;#ffffff&quot;</span></span><br></pre></td></tr></table></figure><p>如果使用 <code>@EnableExceptionLog(showAll = true)</code>，则会打印全部异常堆栈（默认是 <code>false</code>，也就是只打印注解所在类的包相关，Spring 一堆业务无关的不打印）</p><p>注解支持属性</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableExceptionLog(</span></span><br><span class="line"><span class="meta">    showAll = true,</span></span><br><span class="line"><span class="meta">    borderColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    borderBackgroundColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    borderBlink = true,</span></span><br><span class="line"><span class="meta">    textColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    textBackgroundColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    textBold = true,</span></span><br><span class="line"><span class="meta">    textItalic = true,</span></span><br><span class="line"><span class="meta">    textBlink = true,</span></span><br><span class="line"><span class="meta">    emptySpaceBackgroundColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    allowOverride = true</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure><h1 id="请求响应日志"><a href="#请求响应日志" class="headerlink" title="请求响应日志"></a>请求响应日志</h1><p>这个不支持配置文件配置，只能在注解上进行</p><p>注解支持属性 q</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableExceptionLog(</span></span><br><span class="line"><span class="meta">    borderColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    borderBackgroundColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    borderBlink = true,</span></span><br><span class="line"><span class="meta">    textColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    textBackgroundColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    textBold = true,</span></span><br><span class="line"><span class="meta">    textItalic = true,</span></span><br><span class="line"><span class="meta">    textBlink = true,</span></span><br><span class="line"><span class="meta">    emptySpaceBackgroundColor = <span class="string">&quot;#ffffff&quot;</span>,</span></span><br><span class="line"><span class="meta">    useDefaultColor = true</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure><p>如果使用 <code>@EnableExceptionLog(useDefaultColor = true)</code>，则以下默认配置会生效</p><table><thead><tr><th>响应码</th><th>颜色</th></tr></thead><tbody><tr><td>2xx</td><td>绿</td></tr><tr><td>4xx</td><td>黄</td></tr><tr><td>5xx</td><td>红</td></tr></tbody></table><p>但是只有 API 返回的是 <code>ResponseEntity</code> 才会生效，试过用 <code>HttpServletResponse</code>，获取的响应码全是 200，可能还要再看看</p><div>  <video-js id="videojs-id-786f8ce6-7a4a-4fc8-84ec-12e0b739e24d"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/logger-spring-boot-starter/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsid786f8ce67a4a4fc884ec12e0b739e24d = videojs('videojs-id-786f8ce6-7a4a-4fc8-84ec-12e0b739e24d', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;GitHub: &lt;a href=&quot;https://github.com/linweiyuan/logger-spring-boot-starter&quot;&gt;https://github.com/linweiyuan/logger-spring-boot-starter&lt;/a&gt;&lt;/</summary>
      
    
    
    
    <category term="程序设计" scheme="https://linweiyuan.github.io/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    
    <category term="Kotlin" scheme="https://linweiyuan.github.io/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/Kotlin/"/>
    
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="Kotlin" scheme="https://linweiyuan.github.io/tags/Kotlin/"/>
    
    <category term="Spring Boot" scheme="https://linweiyuan.github.io/tags/Spring-Boot/"/>
    
    <category term="Spring Boot Starter" scheme="https://linweiyuan.github.io/tags/Spring-Boot-Starter/"/>
    
  </entry>
  
  <entry>
    <title>Go+React实现一个基础的前后端分离问卷功能</title>
    <link href="https://linweiyuan.github.io/2022/10/05/Go-React%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%9F%BA%E7%A1%80%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%97%AE%E5%8D%B7%E5%8A%9F%E8%83%BD.html"/>
    <id>https://linweiyuan.github.io/2022/10/05/Go-React%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%9F%BA%E7%A1%80%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%97%AE%E5%8D%B7%E5%8A%9F%E8%83%BD.html</id>
    <published>2022-10-05T04:13:39.000Z</published>
    <updated>2023-03-26T01:20:45.350Z</updated>
    
    <content type="html"><![CDATA[<h1 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h1><p><img src="/2022/10/05/Go-React%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%9F%BA%E7%A1%80%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%97%AE%E5%8D%B7%E5%8A%9F%E8%83%BD/screenshot.png"></p><h1 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h1><h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><p>取一个随便点的名字</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> goquestionapi</span><br><span class="line"><span class="built_in">cd</span> goquestionapi</span><br><span class="line">git init</span><br><span class="line">go mod init github.com/linweiyuan/goquestionapi</span><br></pre></td></tr></table></figure><p>这里和数据库相关的操作会使用两个工具，<code>migrate</code> 和 <code>sqlc</code>，可以用 go 的方式安装，但这边习惯用 pacman，因为包升级好管理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S sqlc</span><br><span class="line">yay -S migrate</span><br></pre></td></tr></table></figure><p>sqlc 是一个代码生成工具，生成的代码中连接数据库的部分用的是 Golang 原生 sql 库，性能极高（官方是这样说的）</p><p>为什么不用 GORM，因为由于多年 Java 开发经验先入为主，看到 GORM 的 API 好多时候会觉得莫名其妙，尝试过几遍，都弃坑了，并且据说有性能问题</p><p>sqlc 可以通过编写简单的 SQL 语句，来自动生成模板代码，那么只需要关注具体的业务逻辑即可，并且可以通过 sqlc.arg() 的方式给占位符起别名，使用起来比较顺手</p><p>数据库用的是 Postgres</p><p>对于这种一个问题多个答案，一对多的结构，其实我自己比较喜欢用 JSON 字段</p><p>为什么不直接用 MongoDB？其实工作多年接触的项目，只用过一次，不是很熟悉</p><p>为什么不用 MySQL？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID   NAME                 CPU %     MEM USAGE / LIMIT     MEM %     NET I/O          BLOCK I/O        PIDS</span><br><span class="line">2057f98237b3   postgres             0.02%     28.57MiB / 15.49GiB   0.18%     3.03kB / 0B      0B / 43.4MB      7</span><br><span class="line">25959b7d7133   mysql                0.27%     159.5MiB / 15.49GiB   1.01%     6.85kB / 0B      115kB / 259MB    39</span><br><span class="line">ef2ecd22745f   mongo                0.30%     68.66MiB / 15.49GiB   0.43%     8.25kB / 0B      4.1kB / 1.29MB   33</span><br></pre></td></tr></table></figure><p>如果开了 performance_schema 呢（默认是开）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID   NAME                 CPU %     MEM USAGE / LIMIT     MEM %     NET I/O          BLOCK I/O        PIDS</span><br><span class="line">bb4ba1c34299   mysql                0.26%     383MiB / 15.49GiB     2.42%     2.5kB / 0B       115kB / 247MB    39</span><br></pre></td></tr></table></figure><p>练手而已</p><p>目前所在公司，新项目也纷纷上 Postgres，不涉及到那些储存过程函数之类，转换下 database schema 概念，其实用起来都没什么区别</p><p>准备数据，数据是从网上拿的，主要是一些问题，然后对应的选项写死了分值，最后根据总分来判断性格（性格测试这东西我本人觉得极为扯淡，有些公司面试还要做，莫名其妙，如果我所在公司也要做，那我前面什么都没说，这个测试好得很，必须做）</p><p>数据准备好，就可以导入数据库，这里用的是 migrate，所以先准备第一版的 SQL</p><p>sqlc 配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="attr">sql:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">engine:</span> <span class="string">&quot;postgresql&quot;</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">&quot;sqlc/migration&quot;</span></span><br><span class="line">    <span class="attr">queries:</span> <span class="string">&quot;sqlc/query&quot;</span></span><br><span class="line">    <span class="attr">gen:</span></span><br><span class="line">      <span class="attr">go:</span></span><br><span class="line">        <span class="attr">package:</span> <span class="string">&quot;sqlc&quot;</span></span><br><span class="line">        <span class="attr">out:</span> <span class="string">&quot;sqlc&quot;</span></span><br></pre></td></tr></table></figure><p>schema 是数据库建表、删表语句，queries 是业务 SQL 的编写地方，然后 package 是生成的 go 代码的包名，out 就是代码生成的文件夹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate create -ext sql -<span class="built_in">dir</span> sqlc/migration -<span class="built_in">seq</span> init</span><br></pre></td></tr></table></figure><p>migrate 参数：</p><ul><li>-ext: 数据脚本扩展名（后缀名）</li><li>-dir: 脚本文件所在地，配合上面 sqlc 的配置文件就是在 sqlc&#x2F;migration 里</li><li>-seq: 就是一个 sequence，自增</li><li>最后是文件名字</li></ul><p>上面的命令就会生成 000001_init.down.sql 和 000001_init.up.sql 这两个文件，up 就是新改动，down 就是回滚，和别的数据库 migration 一样</p><p>首先需要先创建 schema，这里 schema 叫 question，表也叫 question（表则可以在 migration sql 里创建）</p><p>创建好 schema 之后 migrate 和 sqlc 才会好使，不然会有先有鸡还是先有蛋的问题</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SCHEMA question;</span><br></pre></td></tr></table></figure><p>准备 up sql</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">    question (</span><br><span class="line">        id SERIAL <span class="keyword">PRIMARY</span> KEY <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">        title <span class="type">VARCHAR</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">        answer JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">        score JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span></span><br><span class="line">    question (title, answer, score)</span><br><span class="line"><span class="keyword">VALUES</span> (</span><br><span class="line">        <span class="string">&#x27;你更喜欢吃那种水果&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;草莓&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;苹果&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;西瓜&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;菠萝&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;橘子&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;你平时休闲经常去的地方&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;郊外&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;电影院&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;公园&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;商场&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;酒吧&quot;,</span></span><br><span class="line"><span class="string">&quot;F&quot;: &quot;练歌房&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 15,</span></span><br><span class="line"><span class="string">&quot;F&quot;: 20</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;你认为容易吸引你的人是&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;有才气的人&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;依赖你的人&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;优雅的人&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;善良的人&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;性情豪放的人&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;如果你可以成为一种动物，你希望自己是哪种&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;猫&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;马&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;大象&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;猴子&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;狗&quot;,</span></span><br><span class="line"><span class="string">&quot;F&quot;: &quot;狮子&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 15,</span></span><br><span class="line"><span class="string">&quot;F&quot;: 20</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;天气很热，你更愿意选择什么方式解暑&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;游泳&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;喝冷饮&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;开空调&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;如果必须与一个你讨厌的动物或昆虫在一起生活，你能容忍哪一个&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;蛇&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;猪&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;老鼠&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;苍蝇&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;你喜欢看哪类电影、电视剧&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;悬疑推理类&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;童话神话类&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;自然科学类&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;伦理道德类&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;战争枪战类&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;以下哪个是你身边必带的物品&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;打火机&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;口红&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;记事本&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;纸巾&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;手机&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 10</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;你出行时喜欢坐什么交通工具&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;火车&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;自行车&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;汽车&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;飞机&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;步行&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;以下颜色你更喜欢哪种&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;紫&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;黑&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;蓝&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;白&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;黄&quot;,</span></span><br><span class="line"><span class="string">&quot;F&quot;: &quot;红&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 8,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 12,</span></span><br><span class="line"><span class="string">&quot;F&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;下列运动中挑选一个你最喜欢的（不一定擅长）&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;瑜珈&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;自行车&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;乒乓球&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;拳击&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;足球&quot;,</span></span><br><span class="line"><span class="string">&quot;F&quot;: &quot;蹦极&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 8,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;F&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;如果你拥有一座别墅，你认为它应当建立在哪里&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;湖边&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;草原&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;海边&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;森林&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;城中区&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;你更喜欢以下哪种天气现象&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;雪&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;风&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;雨&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;雾&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;雷电&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;你希望自己的窗口在一座30层大楼的第几层&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;七层&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;一层&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;二十三层&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;十八层&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;三十层&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 2,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    ), (</span><br><span class="line">        <span class="string">&#x27;你认为自己更喜欢在以下哪一个城市中生活&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: &quot;丽江&quot;,</span></span><br><span class="line"><span class="string">&quot;B&quot;: &quot;拉萨&quot;,</span></span><br><span class="line"><span class="string">&quot;C&quot;: &quot;昆明&quot;,</span></span><br><span class="line"><span class="string">&quot;D&quot;: &quot;西安&quot;,</span></span><br><span class="line"><span class="string">&quot;E&quot;: &quot;杭州&quot;,</span></span><br><span class="line"><span class="string">&quot;F&quot;: &quot;北京&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">&quot;A&quot;: 1,</span></span><br><span class="line"><span class="string">&quot;B&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;C&quot;: 5,</span></span><br><span class="line"><span class="string">&quot;D&quot;: 8,</span></span><br><span class="line"><span class="string">&quot;E&quot;: 10,</span></span><br><span class="line"><span class="string">&quot;F&quot;: 15</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate -path sqlc/migration -database <span class="string">&quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&amp;search_path=question&quot;</span> -verbose up</span><br></pre></td></tr></table></figure><p>down sql</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> question;</span><br></pre></td></tr></table></figure><p>同理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate -path sqlc/migration -database <span class="string">&quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&amp;search_path=question&quot;</span> -verbose down</span><br></pre></td></tr></table></figure><p>接着就是编写获取问题列表的 SQL</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- name: GetQuestions :many</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> q.id, q.title, q.answer <span class="keyword">FROM</span> question q <span class="keyword">ORDER</span> <span class="keyword">BY</span> q.id;</span><br></pre></td></tr></table></figure><p>根据 sqlc 的规范，<code>-- name: 方法名</code>，这些空格都是必须的，如果返回一条数据就 <code>:one</code>，多条则 <code>:many</code>，如果只是增删，可以用 <code>:exec</code></p><p>执行 <code>sqlc generate</code></p><p>这样就会生成好几个 go 文件，其中生成的方法类似</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queries)</span></span> GetQuestions(ctx context.Context) ([]GetQuestionsRow, <span class="type">error</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是每次都要输入这么长的命令，虽然可以键盘上下，但是有更好的方法，就是 <code>Makefile</code></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">up:</span></span><br><span class="line">migrate -path sqlc/migration -database <span class="string">&quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&amp;search_path=question&quot;</span> -verbose up</span><br><span class="line"></span><br><span class="line"><span class="section">down:</span></span><br><span class="line">migrate -path sqlc/migration -database <span class="string">&quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&amp;search_path=question&quot;</span> -verbose down</span><br><span class="line"></span><br><span class="line"><span class="section">gen:</span></span><br><span class="line">sqlc generate</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: up down gen</span></span><br></pre></td></tr></table></figure><p><code>.PHONY</code> 的作用就是确保执行的是这里定义的命令，比如 Makefile 里定义个 ls，如果不加到 .PHONY 里，则执行的是系统的 ls</p><h2 id="编写业务逻辑"><a href="#编写业务逻辑" class="headerlink" title="编写业务逻辑"></a>编写业务逻辑</h2><p>定义配置类，用到了 <code>viper</code>，有一个好处就是 <code>AutomaticEnv()</code> 能够将环境变量覆盖掉代码配置，这样在部署的时候非常方便，日志则用了 logrus，可以设置不同的级别，还有颜色输出，Java 过来表示很亲切</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> util</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">log <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">configFileName   = <span class="string">&quot;app&quot;</span></span><br><span class="line">configFileSuffix = <span class="string">&quot;env&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">ServerPort <span class="type">string</span> <span class="string">`mapstructure:&quot;SERVER_PORT&quot;`</span></span><br><span class="line"></span><br><span class="line">DBDriver <span class="type">string</span> <span class="string">`mapstructure:&quot;DB_DRIVER&quot;`</span></span><br><span class="line">DBSource <span class="type">string</span> <span class="string">`mapstructure:&quot;DB_SOURCE&quot;`</span></span><br><span class="line"></span><br><span class="line">LogLevel <span class="type">string</span> <span class="string">`mapstructure:&quot;LOG_LEVEL&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadConfig</span><span class="params">(path <span class="type">string</span>)</span></span> (config Config) &#123;</span><br><span class="line">viper.AddConfigPath(path)</span><br><span class="line">viper.SetConfigName(configFileName)</span><br><span class="line">viper.SetConfigType(configFileSuffix)</span><br><span class="line">viper.AutomaticEnv()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := viper.ReadInConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;failed to load config file: [%v]&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := viper.Unmarshal(&amp;config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;failed to parse config file: [%v]&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logLevel, err := log.ParseLevel(config.LogLevel)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;failed to get log level: [%v]&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log.SetLevel(logLevel)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后就可以开启调试了，可以 build 或者直接 run，或者用其他热加载的工具，这里用到了 <code>gowatch</code></p><p>直接执行 gowatch 就可以将终端晾在一边了，和前端开发的体验没什么区别，Java 就要重启，没用过 JRebel</p><p>此时访问本地 8080 就能得到 404 的正确响应了</p><p>接着加一个 <code>CORS</code> 的中间件，这里不加，前端就要 <code>proxy</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">log <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CORS</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">log.Debug(<span class="string">&quot;handle cors...&quot;</span>)</span><br><span class="line"></span><br><span class="line">ctx.Writer.Header().Set(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>)</span><br><span class="line">ctx.Writer.Header().Set(<span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;*&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ctx.Request.Method == http.MethodOptions &#123;</span><br><span class="line">ctx.AbortWithStatus(http.StatusNoContent)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx.Next()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>给 server 加上</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.Use(middleware.CORS())</span><br></pre></td></tr></table></figure><p>API</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> api</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/linweiyuan/goquestionapi/sqlc&quot;</span></span><br><span class="line">log <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> QuestionAPI <span class="keyword">struct</span> &#123;</span><br><span class="line">db *sqlc.Queries</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewQuestionAPI</span><span class="params">(db *sqlc.Queries)</span></span> *QuestionAPI &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;QuestionAPI&#123;db&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *QuestionAPI)</span></span> GetQuestions(ctx *gin.Context) &#123;</span><br><span class="line">questions, err := api.db.GetQuestions(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorf(<span class="string">&quot;failed to get questions: [%v]&quot;</span>, err)</span><br><span class="line">ctx.JSON(http.StatusInternalServerError, gin.H&#123;</span><br><span class="line"><span class="string">&quot;error&quot;</span>: err.Error(),</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line"><span class="string">&quot;questions&quot;</span>: questions,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>路由配置</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> router</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/linweiyuan/goquestionapi/api&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> QuestionRouter <span class="keyword">struct</span> &#123;</span><br><span class="line">api *api.QuestionAPI</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewQuestionRouter</span><span class="params">(api *api.QuestionAPI)</span></span> *QuestionRouter &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;QuestionRouter&#123;api&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(router *QuestionRouter)</span></span> Setup(routerGroup *gin.RouterGroup) &#123;</span><br><span class="line">group := routerGroup.Group(<span class="string">&quot;/questions&quot;</span>)</span><br><span class="line">group.GET(<span class="string">&quot;&quot;</span>, router.api.GetQuestions)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>给 server 加上，并且让其具有查询 db 的功能</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sqlDB, err := sql.Open(config.DBDriver, config.DBSource)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;failed to connect to DB: [%v]&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db := sqlc.New(sqlDB)</span><br><span class="line"></span><br><span class="line">rg := server.Group(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">router.NewQuestionRouter(api.NewQuestionAPI(db)).Setup(rg)</span><br></pre></td></tr></table></figure><p>需要注意一点就是，要让 db 的驱动执行初始化动作</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="string">&quot;github.com/lib/pq&quot;</span></span><br></pre></td></tr></table></figure><p>接着再访问 <code>http://localhost:8080/questions</code>，就能看到数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;questions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;ID&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你更喜欢吃那种水果&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Answer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;A&quot;</span><span class="punctuation">:</span> <span class="string">&quot;草莓&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;B&quot;</span><span class="punctuation">:</span> <span class="string">&quot;苹果&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;西瓜&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;D&quot;</span><span class="punctuation">:</span> <span class="string">&quot;菠萝&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;E&quot;</span><span class="punctuation">:</span> <span class="string">&quot;橘子&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;ID&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你认为自己更喜欢在以下哪一个城市中生活&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Answer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;A&quot;</span><span class="punctuation">:</span> <span class="string">&quot;丽江&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;B&quot;</span><span class="punctuation">:</span> <span class="string">&quot;拉萨&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;昆明&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;D&quot;</span><span class="punctuation">:</span> <span class="string">&quot;西安&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;E&quot;</span><span class="punctuation">:</span> <span class="string">&quot;杭州&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;F&quot;</span><span class="punctuation">:</span> <span class="string">&quot;北京&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>但是 json 的 key 全部大写了，可以在 sqlc 上配置 <code>emit_json_tags</code>，修改后的配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="attr">sql:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">engine:</span> <span class="string">&quot;postgresql&quot;</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">&quot;sqlc/migration&quot;</span></span><br><span class="line">    <span class="attr">queries:</span> <span class="string">&quot;sqlc/query&quot;</span></span><br><span class="line">    <span class="attr">gen:</span></span><br><span class="line">      <span class="attr">go:</span></span><br><span class="line">        <span class="attr">package:</span> <span class="string">&quot;sqlc&quot;</span></span><br><span class="line">        <span class="attr">out:</span> <span class="string">&quot;sqlc&quot;</span></span><br><span class="line">        <span class="attr">emit_json_tags:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>再重新跑一遍 <code>make gen</code>，再刷新页面，就能拿到小写的 key，比较符合习惯</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;questions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你更喜欢吃那种水果&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;answer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;A&quot;</span><span class="punctuation">:</span> <span class="string">&quot;草莓&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;B&quot;</span><span class="punctuation">:</span> <span class="string">&quot;苹果&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;西瓜&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;D&quot;</span><span class="punctuation">:</span> <span class="string">&quot;菠萝&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;E&quot;</span><span class="punctuation">:</span> <span class="string">&quot;橘子&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你认为自己更喜欢在以下哪一个城市中生活&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;answer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;A&quot;</span><span class="punctuation">:</span> <span class="string">&quot;丽江&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;B&quot;</span><span class="punctuation">:</span> <span class="string">&quot;拉萨&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;昆明&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;D&quot;</span><span class="punctuation">:</span> <span class="string">&quot;西安&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;E&quot;</span><span class="punctuation">:</span> <span class="string">&quot;杭州&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;F&quot;</span><span class="punctuation">:</span> <span class="string">&quot;北京&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>至此获取问题列表 API 完成，接着是答题然后计算分数</p><p>这里用到下面的数据结构进行提交，思路还是逐条拿分数出来再叠加，没有太多花里胡哨的 SQL</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;answers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span><span class="punctuation">,</span></span><br><span class="line">        ...</span><br><span class="line"><span class="attr">&quot;15&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>于是根据题目拿分数的 SQL 就会是</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- name: GetQuestionScoreByID :one</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> (</span><br><span class="line">        q.score <span class="operator">-</span><span class="operator">&gt;&gt;</span> sqlc.arg(answer) :: TEXT</span><br><span class="line">    ) :: <span class="type">INT</span> <span class="keyword">AS</span> score</span><br><span class="line"><span class="keyword">FROM</span> question q</span><br><span class="line"><span class="keyword">WHERE</span> q.id <span class="operator">=</span> sqlc.arg(id);</span><br></pre></td></tr></table></figure><p>这里可以用 <code>$1</code>，<code>$2</code> 等的占位符，不过用 <code>sqlc.arg()</code> 就会更加顾名思义一些</p><p>再执行 <code>make gen</code>，生成新代码</p><p>接着编写完答题 API （练手而已，没有太多封装）</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> answersRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">Answers json.RawMessage <span class="string">`json:&quot;answers&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *QuestionAPI)</span></span> HandleAnswers(ctx *gin.Context) &#123;</span><br><span class="line"><span class="keyword">var</span> req answersRequest</span><br><span class="line">err := ctx.ShouldBindJSON(&amp;req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorf(<span class="string">&quot;failed to bind answers json: [%v]&quot;</span>, err)</span><br><span class="line">ctx.JSON(http.StatusBadRequest, util.HandleError(err))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">totalScore := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">questionAnswerMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>)</span><br><span class="line">json.Unmarshal(req.Answers, &amp;questionAnswerMap)</span><br><span class="line"><span class="keyword">for</span> questionID, answer := <span class="keyword">range</span> questionAnswerMap &#123;</span><br><span class="line">getAnswerMappingParams := sqlc.GetQuestionScoreByIDParams&#123;</span><br><span class="line">Answer: answer,</span><br><span class="line">ID:     <span class="type">int32</span>(questionID),</span><br><span class="line">&#125;</span><br><span class="line">score, err := api.db.GetQuestionScoreByID(ctx, getAnswerMappingParams)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorf(<span class="string">&quot;failed to get answer score, questionID: [%d], answer: [%s]&quot;</span>, questionID, answer)</span><br><span class="line">ctx.JSON(http.StatusInternalServerError, util.HandleError(err))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">totalScore += <span class="type">int</span>(score)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result <span class="type">string</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> totalScore &gt;= <span class="number">180</span>:</span><br><span class="line">result = <span class="string">&quot;意志力强，头脑冷静，有较强的领导欲，事业心强，不达目的不罢休。外表和善，内心自傲，对有利于自己的人际关系比较看重，有时显得性格急噪，咄咄逼人，得理不饶人，不利于自己时顽强抗争，不轻易认输。思维理性，对爱情和婚姻的看法很现实，对金钱的欲望一般。&quot;</span></span><br><span class="line"><span class="keyword">case</span> totalScore &gt;= <span class="number">140</span> &amp;&amp; totalScore &lt; <span class="number">179</span>:</span><br><span class="line">result = <span class="string">&quot;聪明，性格活泼，人缘好，善于交朋友，心机较深。事业心强，渴望成功。思维较理性，崇尚爱情，但当爱情与婚姻发生冲突时会选择有利于自己的婚姻。金钱欲望强烈。&quot;</span></span><br><span class="line"><span class="keyword">case</span> totalScore &gt;= <span class="number">100</span> &amp;&amp; totalScore &lt; <span class="number">139</span>:</span><br><span class="line">result = <span class="string">&quot;爱幻想，思维较感性，以是否与自己投缘为标准来选择朋友。性格显得较孤傲，有时较急噪，有时优柔寡断。事业心较强，喜欢有创造性的工作，不喜欢按常规办事。性格倔强，言语犀利，不善于妥协。崇尚浪漫的爱情，但想法往往不切合实际。金钱欲望一般。&quot;</span></span><br><span class="line"><span class="keyword">case</span> totalScore &gt;= <span class="number">70</span> &amp;&amp; totalScore &lt; <span class="number">99</span>:</span><br><span class="line">result = <span class="string">&quot;好奇心强，喜欢冒险，人缘较好。事业心一般，对待工作，随遇而安，善于妥协。善于发现有趣的事情，但耐心较差，敢于冒险，但有时较胆小。渴望浪漫的爱情，但对婚姻的要求比较现实。不善理财。&quot;</span></span><br><span class="line"><span class="keyword">case</span> totalScore &gt;= <span class="number">40</span> &amp;&amp; totalScore &lt; <span class="number">69</span>:</span><br><span class="line">result = <span class="string">&quot;性情温良，重友谊，性格塌实稳重，但有时也比较狡黠。事业心一般，对本职工作能认真对待，但对自己专业以外事物没有太大兴趣，喜欢有规律的工作和生活，不喜欢冒险，家庭观念强，比较善于理财。&quot;</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">result = <span class="string">&quot;散漫，爱玩，富于幻想。聪明机灵，待人热情，爱交朋友，但对朋友没有严格的选择标准。事业心较差，更善于享受生活，意志力和耐心都较差，我行我素。有较好的异性缘，但对爱情不够坚持认真，容易妥协。没有财产观念。&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line"><span class="string">&quot;totalScore&quot;</span>: totalScore,</span><br><span class="line"><span class="string">&quot;result&quot;</span>:     result,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置下路由</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">group.POST(<span class="string">&quot;&quot;</span>, router.api.HandleAnswers)</span><br></pre></td></tr></table></figure><p>简单测试能得到结果</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;散漫，爱玩，富于幻想。聪明机灵，待人热情，爱交朋友，但对朋友没有严格的选择标准。事业心较差，更善于享受生活，意志力和耐心都较差，我行我素。有较好的异性缘，但对爱情不够坚持认真，容易妥协。没有财产观念。&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalScore&quot;</span><span class="punctuation">:</span> <span class="number">32</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>此时 API 就完成了，接着就是部署</p><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>如果按照其他语言，一般都是 <code>FROM</code> 一个官方的基础镜像，然后在上面再进行构建，这样就有第一种</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> <span class="keyword">FROM</span> golang:alpine</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>这样出来的镜像是很大的，因为 golang 的 alpine 镜像本身就很大了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY           TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">golang               alpine    5dd973625d31   4 weeks ago      352MB</span><br></pre></td></tr></table></figure><p>而由于 go 本身特点，可以编译出来一个摆脱其他束缚的二进制文件，因此可以直接上 alpine</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> goquestionapi .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;/app/goquestionapi&quot;</span> ]</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build .</span><br><span class="line"></span><br><span class="line">docker build -t goquestionapi .</span><br></pre></td></tr></table></figure><p>这样 build 出来的程序有 13M，还可以再优化下，<code>-s</code> 可以去掉符号表，<code>-w</code> 可以去掉调试信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags=<span class="string">&quot;-w -s&quot;</span> .</span><br></pre></td></tr></table></figure><p>这样 build 出来的程序只有 8.5M</p><p>跑下镜像测试下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -p 8080:8080 -e DB_SOURCE=<span class="string">&quot;postgresql://postgres:postgres@192.168.31.60:5432/postgres?sslmode=disable&amp;search_path=question&quot;</span> -d goquestionapi</span><br></pre></td></tr></table></figure><p>访问正常拿到数据</p><p>此时 docker 镜像大小为 14.4M</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY           TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">goquestionapi        latest    109360c6fafd   6 minutes ago    14.4MB</span><br></pre></td></tr></table></figure><p>上面说了，由于 go 自身的特性，如果没有额外的需求，还可以用 <code>scratch</code> 镜像，只是这样就不能 sh 进去容器，如果有访问外网的需求，也会报 SSL 证书错误，又或者时区的问题，因为里面确实什么都没有</p><p>这个 scratch 感觉更像是一个概念，不是实际可以摸到的东西，因为如果像其他镜像那样 pull 的话，会报错</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull scratch</span><br><span class="line"></span><br><span class="line">Using default tag: latest</span><br><span class="line">Error response from daemon: <span class="string">&#x27;scratch&#x27;</span> is a reserved name</span><br></pre></td></tr></table></figure><p>这样 build 出来的镜像大小就又小了些</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY           TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">goquestionapi        latest    7ac80b2a1ad0   3 seconds ago    8.86MB</span><br></pre></td></tr></table></figure><p>但是为了后续方便 sh 进去，还是习惯用 alpine，也不差那几兆硬盘</p><p>现如今都在谈 DevOps，谈云原生，一般 cicd 都在云端了，因此会有第二种，分阶段构建</p><p>这个时候就需要一个 go 环境，所以要利用 golang 镜像来做编译，完了再把编译出来的程序，再复制到基础的 alpine 镜像上</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:alpine AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags=<span class="string">&quot;-w -s&quot;</span> .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/goquestionapi .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.env .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;/app/goquestionapi&quot;</span> ]</span></span><br></pre></td></tr></table></figure><p>此时编译正常，镜像小，也能正常运行</p><p><code>docker build</code> 的方式会产生很多 <code>&lt;none&gt;</code> 的没用的镜像，每次还要跑一大串命令，这有点不方便，因此可以用 <code>Docker Compose</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">goquestionapi:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">goquestionapi</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">goquestionapi</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GIN_MODE=release</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_SOURCE=postgresql://postgres:postgres@192.168.31.60:5432/postgres?sslmode=disable&amp;search_path=question</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">LOG_LEVEL=info</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure><p>只要 <code>docker-compose build</code> 就可以把镜像 build 出来，并且可以灵活修改配置，命令不变，和 Makefile 的思想一样</p><p>还有一个好处就是没有 <code>&lt;none&gt;</code> 镜像，代码洁癖+强迫症患者表示很舒服</p><p>此时跑 <code>docker-compose up</code>，也能正常看到数据</p><p>以上是本地部署，线上大多是 Kubernetes 环境</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">goquestionapi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">goquestionapi</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">goquestionapi</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">goquestionapi</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">goquestionapi</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;20Mi&quot;</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GIN_MODE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">release</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_SOURCE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">postgresql://postgres:postgres@postgres-postgresql.default.svc.cluster.local:5432/postgres?sslmode=disable&amp;search_path=question</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">goquestionapi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">goquestionapi</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">goquestionapi</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">goquestionapi</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/api(/|$)(.*)&quot;</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">goquestionapi</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p>由于我本地 K8s 环境是 <code>kind</code>，所以要把镜像 load 进去</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind load docker-image goquestionapi</span><br></pre></td></tr></table></figure><p>有两点需要注意，第一就是确保能拿到镜像，要么给个 tag 不用 latest 再通过加载镜像的方式，要么修改 imagePullPolicy 为 IfNotPresent 或者 Never，要么正确配置仓库地址，无论用 Docker Hub 还是自建</p><p>还有一点就是 postgres 要用 K8s 内部的连接，因为我的 postgres 是用 helm 安装的，所以可以通过 <code>helm status postgres</code> 查看到集群内部链接</p><p>apply 后访问 <code>http://localhost/api/questions</code>，也能正常看到数据</p><p>VSCode 或者 Goland 装好 Kubernetes 插件后，都能很方便直接 apply</p><p>VSCode 的话，配置写在一起会有提示无法对比，只能对比单个的，但是单个的话，已经 apply 了的配置会自动带上时间之类的额外的东西，对比起来也不是很直接，所以这里还是写在一起</p><p>至此，API 部分完</p><h1 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h1><h2 id="前期准备-1"><a href="#前期准备-1" class="headerlink" title="前期准备"></a>前期准备</h2><p>利用 <code>create-react-app</code> 来创建 React 项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn create react-app reactquestionweb</span><br></pre></td></tr></table></figure><p>接着集成第三方组件，<code>axios</code> 刚发布了 <code>1.0.0</code> 版本，会有兼容问题，因此还是用回老版本 <code>0.27.2</code> 版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn add antd</span><br><span class="line">yarn add axios@0.27.2</span><br><span class="line">yarn add use-axios-react</span><br></pre></td></tr></table></figure><h2 id="编写业务逻辑-1"><a href="#编写业务逻辑-1" class="headerlink" title="编写业务逻辑"></a>编写业务逻辑</h2><p>这里没什么好说的了，用函数式组件 + hook 完成网络请求、条件渲染，其他的就按照后端接口约定的参数提交</p><p>不会 CSS，所以没有太多华丽的辞藻显示在页面上</p><h2 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h2><p>部署好多人都喜欢用 node 的镜像然后用 npm start，但其实我这边习惯用 nginx，除了 <code>yarn build</code> 会有优化外，你都 build 出来静态文件了，还要 node 干啥</p><p>Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:alpine AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yarn &amp;&amp; yarn build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> nginx:alpine</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/build /usr/share/nginx/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>compose.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">reactquestionweb:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">reactquestionweb</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">reactquestionweb</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3000</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure><p>k8s.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reactquestionweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">reactquestionweb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">reactquestionweb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">reactquestionweb</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">reactquestionweb</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;20Mi&quot;</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reactquestionweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">reactquestionweb</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reactquestionweb</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">reactquestionweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">reactquestionweb</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>然后访问 <code>http://localhost</code>，一切正常</p><p>到这里就完了，附上项目地址</p><p><a href="https://github.com/linweiyuan/goquestionapi">API</a></p><p><a href="https://github.com/linweiyuan/reactquestionweb">WEB</a></p><hr><p>纯属抛砖玉玉，如果有不同的意见，以你的为准</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;效果图&quot;&gt;&lt;a href=&quot;#效果图&quot; class=&quot;headerlink&quot; title=&quot;效果图&quot;&gt;&lt;/a&gt;效果图&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2022/10/05/Go-React%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA</summary>
      
    
    
    
    <category term="程序设计" scheme="https://linweiyuan.github.io/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    
    
    <category term="Go" scheme="https://linweiyuan.github.io/tags/Go/"/>
    
    <category term="React" scheme="https://linweiyuan.github.io/tags/React/"/>
    
    <category term="sqlc" scheme="https://linweiyuan.github.io/tags/sqlc/"/>
    
    <category term="Postgres" scheme="https://linweiyuan.github.io/tags/Postgres/"/>
    
    <category term="Gin" scheme="https://linweiyuan.github.io/tags/Gin/"/>
    
    <category term="Ant Design" scheme="https://linweiyuan.github.io/tags/Ant-Design/"/>
    
  </entry>
  
  <entry>
    <title>LMMS</title>
    <link href="https://linweiyuan.github.io/2022/10/02/LMMS.html"/>
    <id>https://linweiyuan.github.io/2022/10/02/LMMS.html</id>
    <published>2022-10-02T06:34:34.000Z</published>
    <updated>2023-03-26T01:20:45.354Z</updated>
    
    <content type="html"><![CDATA[<h1 id="我和我的祖国"><a href="#我和我的祖国" class="headerlink" title="我和我的祖国"></a>我和我的祖国</h1><div>  <video-js id="videojs-id-eabd214c-cb9f-424f-954d-7b55d8637ccb"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/lmms-my-people-my-country/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsideabd214ccb9f424f954d7b55d8637ccb = videojs('videojs-id-eabd214c-cb9f-424f-954d-7b55d8637ccb', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> <h1 id="神话"><a href="#神话" class="headerlink" title="神话"></a>神话</h1><div>  <video-js id="videojs-id-91f7487b-a9b0-4e34-b6b9-f4fe44f7a0e6"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/lmms-myth/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsid91f7487ba9b04e34b6b9f4fe44f7a0e6 = videojs('videojs-id-91f7487b-a9b0-4e34-b6b9-f4fe44f7a0e6', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> <h1 id="一生所爱"><a href="#一生所爱" class="headerlink" title="一生所爱"></a>一生所爱</h1><div>  <video-js id="videojs-id-960c5926-1d07-4387-9cca-4b2ee7ab5732"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/lmms-love-in-a-life-time/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsid960c59261d0743879cca4b2ee7ab5732 = videojs('videojs-id-960c5926-1d07-4387-9cca-4b2ee7ab5732', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> <h1 id="云宫迅音"><a href="#云宫迅音" class="headerlink" title="云宫迅音"></a>云宫迅音</h1><div>  <video-js id="videojs-id-8b5af14b-9e5d-43bc-8089-90a396e7b372"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/lmms-journey-to-the-west/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsid8b5af14b9e5d43bc808990a396e7b372 = videojs('videojs-id-8b5af14b-9e5d-43bc-8089-90a396e7b372', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> <h1 id="原野追逐"><a href="#原野追逐" class="headerlink" title="原野追逐"></a>原野追逐</h1><div>  <video-js id="videojs-id-d0a6a0f8-8bac-4a1f-aad1-af07cdad7506"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/lmms-cornfield-chase/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsidd0a6a0f88bac4a1faad1af07cdad7506 = videojs('videojs-id-d0a6a0f8-8bac-4a1f-aad1-af07cdad7506', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;我和我的祖国&quot;&gt;&lt;a href=&quot;#我和我的祖国&quot; class=&quot;headerlink&quot; title=&quot;我和我的祖国&quot;&gt;&lt;/a&gt;我和我的祖国&lt;/h1&gt;&lt;div&gt;
  &lt;video-js id=&quot;videojs-id-eabd214c-cb9f-424f-954d-</summary>
      
    
    
    
    <category term="LMMS" scheme="https://linweiyuan.github.io/categories/LMMS/"/>
    
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="LMMS" scheme="https://linweiyuan.github.io/tags/LMMS/"/>
    
  </entry>
  
  <entry>
    <title>IntelliJ IDEA Conf 2022</title>
    <link href="https://linweiyuan.github.io/2022/10/01/IntelliJ-IDEA-Conf-2022.html"/>
    <id>https://linweiyuan.github.io/2022/10/01/IntelliJ-IDEA-Conf-2022.html</id>
    <published>2022-10-01T05:09:00.000Z</published>
    <updated>2023-03-26T01:20:45.350Z</updated>
    
    <content type="html"><![CDATA[<p>看完了的 <code>IntelliJ IDEA Conf 2022 (day 1)</code> 和 <code>IntelliJ IDEA Conf 2022 (day 2)</code><br>写一下印象比较深的和观后感</p><h1 id="day1"><a href="#day1" class="headerlink" title="day1"></a>day1</h1><h2 id="Surviving-Open-Source-by-Donald-Raab"><a href="#Surviving-Open-Source-by-Donald-Raab" class="headerlink" title="Surviving Open Source, by Donald Raab"></a>Surviving Open Source, by Donald Raab</h2><p>介绍了这位老哥参与开源项目的心路历程</p><h2 id="Let’s-Set-Sail-With-Fleet-by-Vitaly-Bragilevsky"><a href="#Let’s-Set-Sail-With-Fleet-by-Vitaly-Bragilevsky" class="headerlink" title="Let’s Set Sail With Fleet!, by Vitaly Bragilevsky"></a>Let’s Set Sail With Fleet!, by Vitaly Bragilevsky</h2><p>（用了英文单引号，但是会自动变成了中文的，可能和配置有关）</p><p>这位老哥非常风趣幽默</p><p>在演示分布式计算器应用的加法功能时，<code>2 + 3 = -1</code>，<code>5 + 6 = -1</code>，评论区炸了锅，纷纷提出自己的解决方案</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">​Add is disabled</span><br><span class="line">...</span><br><span class="line">​addition uses subtract microservice</span><br><span class="line">...</span><br><span class="line">​you&#x27;re subtracting</span><br><span class="line">...</span><br><span class="line">​Looks like &#x27;+&#x27; is mapped to &#x27;-&#x27; button</span><br><span class="line">...</span><br><span class="line">​you have minus in your java implementation</span><br></pre></td></tr></table></figure><p>但其实是故意装作翻车的样子，节目效果罢了，实则是为了展示 Fleet 的远程协助功能（类似 IDEA 的 Code With Me）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">give them both an Oscar already</span><br></pre></td></tr></table></figure><p>最后 QA 环节，当问到 Fleet 是不是为了替换 IDEA 而弄出来的时候，主持人挑了挑眉，然后老哥吞了下口水，也比较搞笑，感觉有点像送命题</p><p>以下是他的原话（自动生成的字幕有部分错误，这里做了调整和删了部分 uh 语气词）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">I think Fleet is not designed to replace IntelliJ IDEA.</span><br><span class="line"></span><br><span class="line">So what I&#x27;ve showed you here is an IDE for working with polyglot projects with stuff like that, but I don&#x27;t think that when you have a project in Java or in Kotlin or in one language that Fleet will be enough for your experience.</span><br><span class="line"></span><br><span class="line">So I believe from my point of view, it&#x27;s not official statement from JetBrains by the way by no means.</span><br><span class="line"></span><br><span class="line">So what I feel, for me like when I have this dedicated project in one language, it&#x27;s great to use IDEA or maybe CLI with all that stuff and that very powerful IDE, but if you want to do something quickly, to edit something, to check something, then Fleet is great.</span><br><span class="line"></span><br><span class="line">So it&#x27;s not a replacement as I see, it&#x27;s a very nice addition.</span><br><span class="line"></span><br><span class="line">So that&#x27;s what I think.</span><br></pre></td></tr></table></figure><p>总的来说，Fleet 不是为了替换 IDEA 而弄出来的（求生欲拉满），只是作为一个补充，或者辅助工具</p><p>但是支持多语种，轻量级的特性，明眼人都看出来是对标 VSCode。。。</p><h2 id="Should-I-Upgrade-to-Java-17-by-Nikhil-Nanivadekar"><a href="#Should-I-Upgrade-to-Java-17-by-Nikhil-Nanivadekar" class="headerlink" title="Should I Upgrade to Java 17?, by Nikhil Nanivadekar"></a>Should I Upgrade to Java 17?, by Nikhil Nanivadekar</h2><p>主要是做了一些 Benchmark，JDK 8，JDK 11，JDK 17，JDK 17 的数据总体来说比低版本的好看，性能更强，内存占用更低</p><p>然后介绍了 JDK8 以后的新特性</p><p>比如 var 类型推断，switch 支持枚举和表达式，空指针异常打印（一个对象比如 <code>a.b().c().d()</code> 报 NPE，之前很难看出是 a 还是 b() 还是 c() 返回 null，这里会直接打印出来出现 null 的地方，方便 debug），文本块，Instanceof 增强，Record，密封类</p><p>但我感觉他的 PPT 里提到的 JDK 版本是错的。。。</p><p>总的来说，JDK 17 已经 GA 一年多了，JDK19 也 GA 了，明年 JDK 21 LTS 也会 GA，还没升级的赶快升级</p><p>话是这么说，陈年老码谁升谁知道，只要 Spring Boot 不出个 log4j 级别的漏洞，那大环境下 JDK 8 还会存在很久，这个是我感觉的，如果有不同的想法或意见，以你的为准</p><p>新项目是可以用的，如果没用 JDK 11，也可以直接上 JDK 17</p><p>Spring 6，Spring Boot 3，也要 JDK 17 起步</p><p>说句题外话，如果你用过 Kotlin，会发现这些所谓新特性，在 Kotlin 刚出道的时候，基本上是自带的，Java 现在已经慢慢变成 Kotlin 的模样 🐶</p><p>此外，用来对标 Go 协程的 Java 虚拟线程，其实人家 Kotlin 也早就有协程和 Channel 的实现了，在 Docker、云原生等的 buff 加持下，Java 逐渐失去了跨平台的优势，所以搞了个 Spring Native</p><p>感觉作为 20 多年的老大哥，Java 起了个大早，赶了个晚集，在面对后辈异军突起的时候，危机感也挺强的，还是个人观点，有不同的以你的为准</p><h2 id="Event-Streaming-and-Processing-Using-Apache-Pulsar-by-Mary-Grygleski"><a href="#Event-Streaming-and-Processing-Using-Apache-Pulsar-by-Mary-Grygleski" class="headerlink" title="Event Streaming and Processing Using Apache Pulsar, by Mary Grygleski"></a>Event Streaming and Processing Using Apache Pulsar, by Mary Grygleski</h2><p>没怎么了解过这个产品，没有对应的知识储备，讲得很清楚，听起来不是很明白，后面用到了再回头重看一遍</p><p>口音非常熟悉和亲切，不开字幕可以练下听力</p><h2 id="Kubernetes-Native-Java-by-Josh-Long"><a href="#Kubernetes-Native-Java-by-Josh-Long" class="headerlink" title="Kubernetes Native Java, by Josh Long"></a>Kubernetes Native Java, by Josh Long</h2><p>语速一如既往地快，不开字幕好多时候都跟不上</p><p>为什么要升级 JDK 17，他提供了一个很好的比喻（修复 bug 和去掉一些语气词）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">You know, for Spring Framework 6 as we mentioned, you can&#x27;t use Java 8 and Java 11 now, this is for good reason, they are terrible versions to use in production today, there is no situation which using Java 8 or 11, even ironically, is appropriate.</span><br><span class="line"></span><br><span class="line">Java 17 is technically superior to Java 8 in every conceivable way, it&#x27;s faster, more memory efficient, more observable, more secure, more robust, more syntax switch, more performant, more operations, friendly etc.</span><br><span class="line"></span><br><span class="line">It&#x27;s just a better piece of software in every conceivable way.</span><br><span class="line"></span><br><span class="line">It&#x27;s also morally superior to Java 8 in every conceivable way.</span><br><span class="line"></span><br><span class="line">You won&#x27;t like the look of despair and chagrin in your children&#x27;s faces when they find out that you&#x27;re using Java 8 in production.</span><br><span class="line"></span><br><span class="line">Don&#x27;t do it, be the change you want to see in the world, do the right thing.</span><br><span class="line"></span><br><span class="line">Java 17 is the right thing to do in 2022.</span><br><span class="line"></span><br><span class="line">My friends, I don&#x27;t think I need to go on about why Java 17 is an appropriate choice, or Java 17 or later is an appropriate choice, but just, if nothing else, just judging by the version number alone, I think it&#x27;s fair to say that Java 17 is more than twice as good as Java 8.</span><br></pre></td></tr></table></figure><p>重点在最后一句话，好像没毛病</p><p>接着讲了自定义 banner 的改动，Spring Boot 3 不支持图片格式的自动转换了，但是纯文字不影响，主要是用的人少，也出于性能考虑</p><p>后面主要是 Spring Native 相关，如何通过自定义 actuator 接口让 K8s 的 Liveness 和 Readiness 感知，从而使应用保持健康状态</p><p>Spring Native 我也尝试过，build 的时候 CPU 和内存全部跑满，花费一分多钟打包 Docker 镜像，仅仅是一个 Hello World，但是启动确实很快，内存占用也很低（和 Spring Boot Jar 相比），但是要在云原生这块打得过 Go，还要再下点功夫，Go WEB 应用的内存占用 + 静态编译 + Docker 打包一套组合拳确实很舒服，有不同意见以你的为准</p><p>最后介绍了下 Graphql，这个很早就听过但其实没实际用过，心血来潮时再来研究一番，只是第一感觉就是数据的权限粒度问题，别的用户会不会访问到不应该看到的数据，后面用到再详细学习</p><hr><h1 id="day-2"><a href="#day-2" class="headerlink" title="day 2"></a>day 2</h1><h2 id="Idiomatic-Kotlin-by-Anton-Arhipov"><a href="#Idiomatic-Kotlin-by-Anton-Arhipov" class="headerlink" title="Idiomatic Kotlin, by Anton Arhipov"></a>Idiomatic Kotlin, by Anton Arhipov</h2><p>主要是介绍了一些常见的用错的 Kotlin 写法，也不能说错，只是要怎样写才会更地道显得专业，好比英语母语者说东西喜欢中间加个 you know 或者 I mean，非母语者一般不会这样说，但是可能在口语中加上就会显得地道</p><p>作为有过多门编程经验的开发者，有时确实会先入为主，把之前用过的语言的写法用到新学语言上，能跑，但是就是显得不专业</p><p>好多编程语言要解决的问题一样，只是实现的过程不同，或者有自己的专有名词，比如做 WEB 开发，Spring 里的 AOP，在 Python 里面叫装饰器，在 Go 里叫中间件，不能说完全一致，只能说大部分要实现的功能都是相同的</p><p>做 Go 开发的时候，很容易将 Java 的面向对象的思维去做，遇到问题，什么都不说先创建一个类，但是 Go 不是完全面向对象，虽然可以实现面向对象，所以有时候开发前有必要好好过一遍官方文档，要怎么写才能更加 <code>&quot;Gopher&quot;</code></p><h2 id="Stories-of-Building-a-Remote-Development-IDE-by-Matt-Ellis"><a href="#Stories-of-Building-a-Remote-Development-IDE-by-Matt-Ellis" class="headerlink" title="Stories of Building a Remote Development IDE, by Matt Ellis"></a>Stories of Building a Remote Development IDE, by Matt Ellis</h2><p>主要介绍了远程开发和实现这个功能的心路历程</p><p>这个远程开发是代码、系统资源等等全在云端，演示里是用 AWS，国外企业用 AWS 较多，目前我也还没尝试过，国内一兆小水管能干啥？</p><p>远程开发会带来一个问题，调试的时候如何访问 localhost？解决方法是在服务器上进行端口转发，通过访问服务器的相关端口</p><p>还有介绍 Code With Me 的功能</p><p>这个实现远程开发的功能的架构，有点像 MMORPG</p><h2 id="Evolving-JUnit-5-by-Marc-Philipp"><a href="#Evolving-JUnit-5-by-Marc-Philipp" class="headerlink" title="Evolving JUnit 5, by Marc Philipp"></a>Evolving JUnit 5, by Marc Philipp</h2><p>老实说，对 JUnit 的研究不多，所以对于视频的东西好多都是非常陌生，留下的印象也不深（是我个人问题，视频演示很好）</p><h2 id="Project-Loom-Revolution-in-Concurrency-or-Obscure-Implementation-Detail-by-Tomasz-Nurkiewicz"><a href="#Project-Loom-Revolution-in-Concurrency-or-Obscure-Implementation-Detail-by-Tomasz-Nurkiewicz" class="headerlink" title="Project Loom: Revolution in Concurrency or Obscure Implementation Detail?, by Tomasz Nurkiewicz"></a>Project Loom: Revolution in Concurrency or Obscure Implementation Detail?, by Tomasz Nurkiewicz</h2><p>其实很多概念都和其他语言的协程相似，Java 里叫虚拟线程，是一个开发中的功能，需要加参数才能尝试，JDK 19</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java --enable-preview</span><br></pre></td></tr></table></figure><p>从用户线程讲到内核线程，在 Java 的早期版本中，JVM 自己实现了一套调度器，那时计算机还不是非常普及，一般是单核 CPU，但 Java 也能实现多线程的效果，这种是多对一的模型，也叫绿色线程，绿色线程并不依赖底层的操作系统，线程的调度都发生在用户空间</p><p>在多核的环境下，这种多对一的模型就不能发挥优势了，从实现的效果来说，绿色线程实现的是并发不是并行，因此出现第二种模型</p><p>多对多模型，一堆用户线程对应一堆内核线程，也是由 JVM 进行调度，用得不多</p><p>随着 JVM 和操作系统的日渐成熟以及计算机的发展，最后出现的是一对一模型，一个用户线程对应一个内核线程，而在一般情况下，Linux 系统会将线程看作进程（其他系统不是），所以线程的创建是比较耗费系统资源的（默认 1M）</p><p>Java 里的虚拟线程，主要由三部分组成：</p><ul><li>Virtual thread：非常轻量的用户线程（相当于其他语言的协程、或者 Task）</li><li>Carrier thread：JDK 19 前的 Java 线程，对应着一条内核线程，虚拟线程 pin 在这里进行处理</li><li>Continuation：一堆可以被暂停的代码，当在方法中暂停，再执行，不会从头执行方法，而是在暂停处接着执行（PPT 原文：A piece of code that can be paused, at almost no cost）</li></ul><p>有种 IO 多路复用的感觉</p><p>虚拟线程和普通线程的用法基本一样，但是线程池可以免了，因为可以创建非常多的虚拟线程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.startVirtualThread(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread</span><br><span class="line">    .ofVirtual()</span><br><span class="line">    .name(<span class="string">&quot;MyThread&quot;</span>)</span><br><span class="line">    .unstarted(() -&gt; task());</span><br><span class="line"></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">es</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor();</span><br><span class="line"></span><br><span class="line"><span class="type">ThreadFactory</span> <span class="variable">factory</span> <span class="operator">=</span> Thread</span><br><span class="line">    .ofVirtual()</span><br><span class="line">    .factory();</span><br></pre></td></tr></table></figure><h2 id="JavaFX-for-Mobile-Development-by-Gail-Anderson"><a href="#JavaFX-for-Mobile-Development-by-Gail-Anderson" class="headerlink" title="JavaFX for Mobile Development, by Gail Anderson"></a>JavaFX for Mobile Development, by Gail Anderson</h2><p>主要介绍 JavaFX 和 Gluon，但是已经偏了 WEB 这条路了，所以没有太认真听</p><p>刚学 Java 时倒是做过一些 GUI 应用，也写过 Android，最后还是回到了 WEB</p><p>找机会重新看一遍</p><hr><p>最后附上原视频（科学）：</p><h1 id="day-1"><a href="#day-1" class="headerlink" title="day 1"></a>day 1</h1><p>Agenda:</p><p>0:00 – Countdown<br>0:53 – Introduction<br>4:35 – Keynote: Surviving Open Source, by Donald Raab<br>1:01:27 – Let’s Set Sail With Fleet!, by Vitaly Bragilevsky<br>1:59:46 – Should I Upgrade to Java 17?, by Nikhil Nanivadekar<br>3:01:06 – Event Streaming and Processing Using Apache Pulsar, by Mary Grygleski<br>4:00:19 – Kubernetes Native Java, by Josh Long</p><div class="video"><iframe width="560" height="315" src="https://www.youtube.com/embed/vmS9vNbta-w" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div><h1 id="day-2-1"><a href="#day-2-1" class="headerlink" title="day 2"></a>day 2</h1><p>Agenda:</p><p>0:00 – Countdown<br>0:53 – Introduction<br>5:49 – Idiomatic Kotlin, by Anton Arhipov<br>1:03:12 – Wish You Were Here: Stories of Building a Remote Development IDE, by Matt Ellis<br>2:01:22 – Evolving JUnit 5, by Marc Philipp<br>3:01:18 – Project Loom: Revolution in Concurrency or Obscure Implementation Detail?, by Tomasz Nurkiewicz<br>4:02:37 – JavaFX for Mobile Development, by Gail Anderson</p><div class="video"><iframe width="560" height="315" src="https://www.youtube.com/embed/-8epeIFdKWo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;看完了的 &lt;code&gt;IntelliJ IDEA Conf 2022 (day 1)&lt;/code&gt; 和 &lt;code&gt;IntelliJ IDEA Conf 2022 (day 2)&lt;/code&gt;&lt;br&gt;写一下印象比较深的和观后感&lt;/p&gt;
&lt;h1 id=&quot;day1&quot;&gt;&lt;a hr</summary>
      
    
    
    
    <category term="社区活动" scheme="https://linweiyuan.github.io/categories/%E7%A4%BE%E5%8C%BA%E6%B4%BB%E5%8A%A8/"/>
    
    
    <category term="Java" scheme="https://linweiyuan.github.io/tags/Java/"/>
    
    <category term="Kotlin" scheme="https://linweiyuan.github.io/tags/Kotlin/"/>
    
    <category term="IntelliJ IDEA Conf" scheme="https://linweiyuan.github.io/tags/IntelliJ-IDEA-Conf/"/>
    
  </entry>
  
  <entry>
    <title>Go实现Pod后台端口转发</title>
    <link href="https://linweiyuan.github.io/2022/09/27/Go%E5%AE%9E%E7%8E%B0Pod%E5%90%8E%E5%8F%B0%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91.html"/>
    <id>https://linweiyuan.github.io/2022/09/27/Go%E5%AE%9E%E7%8E%B0Pod%E5%90%8E%E5%8F%B0%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91.html</id>
    <published>2022-09-27T18:39:50.000Z</published>
    <updated>2023-03-26T01:20:45.350Z</updated>
    
    <content type="html"><![CDATA[<p>GitHub: <a href="https://github.com/linweiyuan/goportforwarder">https://github.com/linweiyuan/goportforwarder</a></p><p>在 Kubernetes in docker (kind) 的环境下，没有找到好用的支持后台运行的端口转发方案，自己实现了个简单的</p><div>  <video-js id="videojs-id-1efaba2d-47db-46e5-a577-51e551932afb"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/go-port-forward/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsid1efaba2d47db46e5a57751e551932afb = videojs('videojs-id-1efaba2d-47db-46e5-a577-51e551932afb', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;GitHub: &lt;a href=&quot;https://github.com/linweiyuan/goportforwarder&quot;&gt;https://github.com/linweiyuan/goportforwarder&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在 Kubernetes in </summary>
      
    
    
    
    <category term="操作系统" scheme="https://linweiyuan.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://linweiyuan.github.io/tags/Kubernetes/"/>
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="Golang" scheme="https://linweiyuan.github.io/tags/Golang/"/>
    
    <category term="Pod" scheme="https://linweiyuan.github.io/tags/Pod/"/>
    
  </entry>
  
  <entry>
    <title>Ingress配置pgAdmin需要注意的问题</title>
    <link href="https://linweiyuan.github.io/2022/09/23/Ingress%E9%85%8D%E7%BD%AEpgAdmin%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E9%97%AE%E9%A2%98.html"/>
    <id>https://linweiyuan.github.io/2022/09/23/Ingress%E9%85%8D%E7%BD%AEpgAdmin%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E9%97%AE%E9%A2%98.html</id>
    <published>2022-09-23T17:32:34.000Z</published>
    <updated>2023-03-26T01:20:45.350Z</updated>
    
    <content type="html"><![CDATA[<p>当使用 Docker 或者 Docker Compose 部署 pgAdmin 来方便本地开发访问使用的时候，是不需要额外注意的，因为通常都是直接暴露端口出去</p><p>但是基于 K8s 环境下部署的时候，需要稍微注意一点地方</p><h1 id="K8s-集群准备"><a href="#K8s-集群准备" class="headerlink" title="K8s 集群准备"></a>K8s 集群准备</h1><p>K8s 的搭建方式多种多样，比如 k3d、kubeadm、kind 等，由于多年之前有裸装 Oracle 把系统搞烂的经历，对于一些软件的安装，我这边是比较谨慎的。况且后面接触了容器，能在里面跑就里面跑，什么两倍读写的问题不考虑，所以我使用的是 <code>kind</code> 来搭建集群</p><p>为了服务在容器外能访问，kind 创建 K8s 集群的时候还需要一些额外的配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">apiServerAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">apiServerPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">control-plane</span></span><br><span class="line">    <span class="attr">kubeadmConfigPatches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">        kind: InitConfiguration</span></span><br><span class="line"><span class="string">        nodeRegistration:</span></span><br><span class="line"><span class="string">          kubeletExtraArgs:</span></span><br><span class="line"><span class="string">            node-labels: &quot;ingress-ready=true&quot;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">extraPortMappings:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">        <span class="attr">hostPort:</span> <span class="number">443</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><h1 id="Ingress-Controller-准备"><a href="#Ingress-Controller-准备" class="headerlink" title="Ingress Controller 准备"></a>Ingress Controller 准备</h1><p>K8s 暴露服务的方式也多种多样，比如 NodePort、LoadBalancer、Ingress。由于 kind 的特殊性，整个 K8s 集群都跑在容器中，所以就算 NodePort 也是容器里的端口，所以这次主要讨论 Ingress，使用的是 <code>Nginx</code></p><p>使用 Ingress，首先需要在集群中安装一个 Ingress Controller，然后通过 Ingress 来进行一些配置，当 apply 的时候，Ingress Controller 会自动更新 nginx.conf 并进行 reload</p><p>如果之前配置过 Nginx，其实类比起来是很像的，一个 Ingress Controller 相当于一个 Nginx，一个 Ingress 则好比 Nginx 的配置文件</p><p>当 Ingress Controller 准备好后，会以 NodePort 的方式暴露 80 和 443 端口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx-controller             NodePort    10.96.30.54    &lt;none&gt;        80:30860/TCP，443:31875/TCP   3d</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="pgAdmin-准备"><a href="#pgAdmin-准备" class="headerlink" title="pgAdmin 准备"></a>pgAdmin 准备</h1><p>为了简单起见，使用 <code>helm</code> 来安装 pgAdmin</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install pgadmin runix/pgadmin4 --<span class="built_in">set</span> env.email=root@linweiyuan.com --<span class="built_in">set</span> env.password=toor</span><br></pre></td></tr></table></figure><h1 id="Ingress-准备"><a href="#Ingress-准备" class="headerlink" title="Ingress 准备"></a>Ingress 准备</h1><p>配置好 Ingress 规则，因为想做到访问不同的 path 路由到不同的服务，所以这里用 &#x2F;pgAdmin 来设置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/pgAdmin&quot;</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">pgadmin-pgadmin4</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>但是此时访问 <a href="http://localhost/pgAdmin">http://localhost/pgAdmin</a> 的时候，会返回 404</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Not Found The requested URL was not found on the server. If you entered the URL</span><br><span class="line">manually please check your spelling and try again.</span><br></pre></td></tr></table></figure><h1 id="pgAdmin-访问解决"><a href="#pgAdmin-访问解决" class="headerlink" title="pgAdmin 访问解决"></a>pgAdmin 访问解决</h1><p>查看<a href="https://www.pgadmin.org/docs/pgadmin4/latest/container_deployment.html#http-via-nginx">官方文档</a>，会发现这么一句话</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If you wish to host pgAdmin under a subdirectory rather than on the root of the server, you must specify the location and set the X-Script-Name header which tells the pgAdmin container how to rewrite paths</span><br></pre></td></tr></table></figure><p>就是说 Nginx 的配置里要加 <code>X-Script-Name</code>，但是在 K8s 里要怎么加？</p><p>前面提过，其实无非是修改 Ingress 的配置，此时如果进入 Ingress Controller 的 pod 中查看配置文件，会发现当前配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash-5.1$ hostname</span><br><span class="line">ingress-nginx-controller-65b4b4df7d-rhd2k</span><br><span class="line">bash-5.1$ <span class="built_in">cat</span> -n nginx.conf | grep pgAdmin</span><br><span class="line">   297location /pgAdmin/ &#123;</span><br><span class="line">   303<span class="built_in">set</span> <span class="variable">$location_path</span>  <span class="string">&quot;/pgAdmin&quot;</span>;</span><br><span class="line">   415location = /pgAdmin &#123;</span><br><span class="line">   421<span class="built_in">set</span> <span class="variable">$location_path</span>  <span class="string">&quot;/pgAdmin&quot;</span>;</span><br></pre></td></tr></table></figure><p>而根据 pgAdmin 官方文档的指引，需要把配置加到 location 下，回头查看 <a href="https://github.com/kubernetes/ingress-nginx/blob/main/docs/user-guide/nginx-configuration/annotations.md#configuration-snippet">K8s 官方文档</a>，发现其实是配置 <code>nginx.ingress.kubernetes.io/configuration-snippet</code></p><p>因此配置文件进行修改，完整配置文件如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      proxy_set_header X-Script-Name /pgAdmin;</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/pgAdmin&quot;</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">pgadmin-pgadmin4</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>再 apply</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kaf pgadmin-ingress.yaml</span><br><span class="line">ingress.networking.k8s.io/pgadmin-ingress configured</span><br></pre></td></tr></table></figure><p>再查看 nginx.conf，已经生效了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash-5.1$ <span class="built_in">cat</span> -n nginx.conf | grep pgAdmin</span><br><span class="line">   297location /pgAdmin/ &#123;</span><br><span class="line">   303<span class="built_in">set</span> <span class="variable">$location_path</span>  <span class="string">&quot;/pgAdmin&quot;</span>;</span><br><span class="line">   409proxy_set_header X-Script-Name /pgAdmin;</span><br><span class="line">   417location = /pgAdmin &#123;</span><br><span class="line">   423<span class="built_in">set</span> <span class="variable">$location_path</span>  <span class="string">&quot;/pgAdmin&quot;</span>;</span><br><span class="line">   529proxy_set_header X-Script-Name /pgAdmin;</span><br></pre></td></tr></table></figure><p>此时再访问 <a href="http://localhost/pgAdmin">http://localhost/pgAdmin</a></p><p>会自动跳转 <a href="http://localhost/pgAdmin/login?next=/pgAdmin/">http://localhost/pgAdmin/login?next=%2FpgAdmin%2F</a></p><p>用上面 helm 设置的用户名和密码即可登录进去，问题解决</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;当使用 Docker 或者 Docker Compose 部署 pgAdmin 来方便本地开发访问使用的时候，是不需要额外注意的，因为通常都是直接暴露端口出去&lt;/p&gt;
&lt;p&gt;但是基于 K8s 环境下部署的时候，需要稍微注意一点地方&lt;/p&gt;
&lt;h1 id=&quot;K8s-集群准备&quot;</summary>
      
    
    
    
    <category term="容器技术" scheme="https://linweiyuan.github.io/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Kubernetes" scheme="https://linweiyuan.github.io/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://linweiyuan.github.io/tags/Kubernetes/"/>
    
    <category term="pgAdmin" scheme="https://linweiyuan.github.io/tags/pgAdmin/"/>
    
    <category term="Ingress" scheme="https://linweiyuan.github.io/tags/Ingress/"/>
    
  </entry>
  
  <entry>
    <title>利用 Github Actions 实现代码提交自动部署更新 Kubernetes</title>
    <link href="https://linweiyuan.github.io/2022/09/13/%E5%88%A9%E7%94%A8GithubActions%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%8F%90%E4%BA%A4%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E6%9B%B4%E6%96%B0Kubernetes.html"/>
    <id>https://linweiyuan.github.io/2022/09/13/%E5%88%A9%E7%94%A8GithubActions%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%8F%90%E4%BA%A4%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E6%9B%B4%E6%96%B0Kubernetes.html</id>
    <published>2022-09-13T04:31:35.000Z</published>
    <updated>2023-03-26T01:20:45.358Z</updated>
    
    <content type="html"><![CDATA[<p>GitHub: <a href="https://github.com/linweiyuan/github-actions-tests">https://github.com/linweiyuan/github-actions-tests</a></p><p>可以换掉大部分 Jenkins + webhooks 的场景</p><div>  <video-js id="videojs-id-9f8344c6-694e-4842-bfeb-87776abf0469"     class="vjs-default-skin vjs-16-9"     controls     preload="auto"     width="100%"     height="350px">    <source src="https://video.linweiyuan.com/github-actions-update-kubernetes/index.m3u8" type="application&#x2F;x-mpegURL">  </video-js>      <script>    const videojsid9f8344c6694e4842bfeb87776abf0469 = videojs('videojs-id-9f8344c6-694e-4842-bfeb-87776abf0469', {      html5: {        hls: {          overrideNative: true        }      }    });  </script>  </div> ]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;GitHub: &lt;a href=&quot;https://github.com/linweiyuan/github-actions-tests&quot;&gt;https://github.com/linweiyuan/github-actions-tests&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;可以换掉大部</summary>
      
    
    
    
    <category term="Github Actions" scheme="https://linweiyuan.github.io/categories/Github-Actions/"/>
    
    
    <category term="Kubernetes" scheme="https://linweiyuan.github.io/tags/Kubernetes/"/>
    
    <category term="视频" scheme="https://linweiyuan.github.io/tags/%E8%A7%86%E9%A2%91/"/>
    
    <category term="Golang" scheme="https://linweiyuan.github.io/tags/Golang/"/>
    
    <category term="Github Actions" scheme="https://linweiyuan.github.io/tags/Github-Actions/"/>
    
  </entry>
  
</feed>
